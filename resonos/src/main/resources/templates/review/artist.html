<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{/layouts/main_layout}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${artist.name}">ì•„í‹°ìŠ¤íŠ¸ ì •ë³´</title>
    <th:block th:replace="~{fragments/link::artist}"></th:block>
</head>

<body layout:fragment="content">
    <div class="wrapper">
        <!-- ì•„í‹°ìŠ¤íŠ¸ ì¹´ë“œ -->
        <div class="artist-card">
            <div class="artist-overall">
                <div class="artist-img">
                    <img th:src="@{${artist.profileImage}}" alt="">
                </div>
                <div class="artist-info">
                    <p id="headline" th:text="${artist.name}"></p>
                    <p th:text="|ğŸ’½ì•¨ë²” : ${albumCount}|">ì•¨ë²” 30</p>
                    <p th:text="|ğŸ¶ê³¡ : ${trackCount}|">ê³¡ 300</p>
                    <div style="display: flex; gap: 15px;">
                        <button type="button" id="followArtistBtn" class="btn btn-gold" th:data-artist-id="${artist.id}"
                            th:data-user-id="${loginUser != null ? loginUser.id : 0}"
                            th:data-followed="${isArtistFollowed}">
                            <span id="followText"
                                th:text="${isArtistFollowed != null and isArtistFollowed ? 'íŒ”ë¡œìš°â¤ï¸' : 'íŒ”ë¡œìš°ğŸ¤'}"></span>
                            <span id="followCount" th:text="${followCount}">0</span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="disco-graphy">
                <div class="graphy-header">
                    <p id="headline">ë””ìŠ¤ì½” ê·¸ë˜í”¼</p>
                </div>
                <div class="album-container">
                    <!-- ë°˜ë³µë¬¸ êµ¬ê°„ -->
                    <th:block th:each="album : ${albums}">
                        <a th:href="@{albums(id=${album.id})}">
                            <div class="album">
                                <div class="album-img">
                                    <img th:src="@{${album.coverImage}}" alt="">
                                    <span class="center-pin"></span>
                                </div>
                                <div class="album-info">
                                    <p id="subtitle" th:text="${album.title}">ì•¨ë²”ëª…</p>
                                    <p th:text="${#dates.format(album.releaseDate, 'yyyy-MM-dd')}">ì¶œì‹œì¼</p>
                                    <p th:text="${album.label}">ë ˆì´ë¸”</p>
                                </div>
                            </div>
                        </a>
                    </th:block>
                </div>
            </div>
        </div>
        <!-- ì•„í‹°ìŠ¤íŠ¸ ì¹´ë“œ ë -->
        <!-- ì¸ê¸°ê³¡ ìœ íŠœë¸Œ -->
        <div class="hottest-card">
            <div class="songs">
                <p id="headline" th:text="|${artist.name}'s ğŸ”¥TOP ${#lists.size(TOP7)}|"></p>
                <!-- ë°˜ë³µë¬¸ ì¸ê¸°ê³¡ -->
                <th:block th:each="tops, stat : ${TOP7}">
                    <a th:href="@{/tracks(id=${tops.id})}">
                        <p th:text="|${stat.count}. ${tops.title}  |"></p>
                        <span th:text="${tops.formattedDuration}"></span>
                    </a>
                </th:block>
            </div>
            <div class="youtube">
                <th:block th:if="${!#strings.isEmpty(track.mvUrl) and track.mvUrl != 'N/A'}">
                    <iframe width="560" height="315" th:src="|https://www.youtube.com/embed/${track.mvUrl}|"
                        title="YouTube video player" frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                        referrerpolicy="strict-origin-when-cross-origin" allowfullscreen>
                    </iframe>
                </th:block>
                <th:block th:if="${#strings.isEmpty(track.mvUrl) or track.mvUrl == 'N/A'}">
                    <img th:src="@{/img/wait_plz.png}" alt="ë®¤ì§ë¹„ë””ì˜¤ ì¤€ë¹„ì¤‘" width="560" height="315"
                        style="object-fit:cover;">
                </th:block>
            </div>
        </div>
        <!-- ì¸ê¸°ê³¡ ì¹´ë“œ ë -->
        <!-- ì•„í‹°ìŠ¤íŠ¸ ë¦¬ë·°/ì¼ì •.. -->
        <div class="info-card">
            <div class="info recent-review">
                <p id="headline" th:text="|${artist.name} ìµœê·¼ ë¦¬ë·°|"></p>
                <th:block th:if="${recentReviews == null or recentReviews.isEmpty()}">
                    <p id="headline">ì•„ì§ ë¦¬ë·°ê°€ ì—†ì–´ìš”</p>
                </th:block>
                <th:block th:if="${recentReviews != null and !recentReviews.isEmpty()}">
                    <a th:each="review : ${recentReviews}"
                        th:href="@{${review.type == 'TRACK' ? 'tracks?id=' + review.id : 'albums?id=' + review.id}}"
                        class="review-line">
                        <span class="review-icon" th:text="${review.type == 'TRACK' ? '[ğŸµ]' : '[ğŸ’½]'}"></span>
                        <strong class="review-title" th:text="${review.name}">ì œëª©</strong>
                        <span class="review-content" th:text="${review.content}">ë‚´ìš©</span>
                        <span class="review-box" th:text="|â¤ï¸ ${review.likeCount}|">â¤ï¸ 0</span>
                        <span class="review-box"
                            th:text="${#temporals.format(review.createdAt, 'yyyy.MM.dd HH:mm')}">ë‚ ì§œ</span>
                    </a>
                </th:block>
            </div>
            <div class="info concert-schedule">
                <p id="headline">ê³µì—°/ì´ë²¤íŠ¸ ì¼ì •</p>
                <div class="bit-widget-initializer" th:data-artist-name="${artist.name}" data-text-color="#FFF"
                    data-background-color="transparent" data-display-local-dates="true" data-auto-style="true"
                    data-separator-color="#DDDDDD" data-link-color="#1DB954" data-display-limit="3"
                    data-display-lineup="false" data-display-play-my-city="false">
                </div>

            </div>
        </div>
        <!-- ì•„í‹°ìŠ¤íŠ¸ ë¦¬ë·°/ì¼ì •.. -->
        <!-- ë¶„ìœ„ê¸° -->
        <div class="mood-card">
            <div class="chart">
                <th:block th:if="${isMoodEmpty}">
                    <p id="headline">ì•„ì§ ì•„ë¬´ë„ ë¶„ìœ„ê¸°ì— íˆ¬í‘œí•˜ì§€ ì•Šì•˜ì–´ìš” ğŸ˜…</p>
                </th:block>
                <th:block th:if="${!isMoodEmpty}">
                    <canvas id="hexRadarChart"></canvas>
                </th:block>
            </div>
            <div class="mood-vote">
                <div class="vote-header">
                    <p id="headline">Mood Tags</p>
                </div>
                <div class="moods" th:data-user-id="${loginUser != null ? loginUser.id : 0}"
                    th:data-artist-id="${artist.id}" id="moodVoteContainer">
                    <th:block th:each="tag : ${tags}">
                        <label class="btn btn-gold mood-option"
                            th:classappend="${userVotedMoodId == tag.id} ? 'selected'">
                            <input type="radio" name="moodVote" th:value="${tag.id}"
                                th:checked="${userVotedMoodId == tag.id}" hidden />
                            <span th:text="${tag.name}">ë¶„ìœ„ê¸°</span>
                        </label>
                    </th:block>
                </div>
                <button class="btn btn-gold" id="submitMoodVote" th:if="${loginUser != null}">íˆ¬í‘œí•˜ê¸°</button>
            </div>
            <div class="album-moods">
                <p id="headline">ë¶„ìœ„ê¸°ë¡œ ë…¸ë˜ì°¾ê¸°</p>
                <th:block th:if="${moodLabels == null || moodLabels.isEmpty()}">
                    <p style="color: var(--main-color);">ì•„ì§ ì•„ë¬´ë„ ë¶„ìœ„ê¸°ì— íˆ¬í‘œí•˜ì§€ ì•Šì•˜ì–´ìš” ğŸ˜…</p>
                </th:block>
                <th:block th:if="${moodLabels != null}">
                    <div class="mood-list">
                        <a th:each="topMoods : ${moodLabels}" th:href="@{/search(q=${'#' + topMoods})}">
                            <button class="btn btn-gold" th:text="|#${topMoods}|">ë¶„ìœ„ê¸°1</button>
                        </a>
                    </div>
                </th:block>
            </div>
        </div>
        <!-- ë¶„ìœ„ê¸° ë -->
    </div>

    <script th:inline="javascript">
        const isLogin = [[${ loginUser != null ? 'true' : 'false'}]];
    </script>
    <script src="https://widget.bandsintown.com/main.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            setTimeout(() => {
                const container = document.querySelector(".bit-widget-container");

                // ë Œë”ë§ëœ ìœ„ì ¯ ë‚´ë¶€ div ê¸°ì¤€ ê²€ì‚¬
                const inner = container?.querySelector("div");
                const isEmpty = !inner || inner.children.length === 0;

                if (isEmpty) {
                    console.log("âŒ Bandsintown: ì•„í‹°ìŠ¤íŠ¸ ë¯¸ë“±ë¡ ë˜ëŠ” ê³µì—° ì—†ìŒ");

                    // ì‚¬ìš©ì ì•ˆë‚´ ë©”ì‹œì§€ ì‚½ì…
                    container.innerHTML = `
                <p style="color: var(--main-color); font-size: 1.2rem;">
                    ë“±ë¡ëœ ê³µì—° ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.
                </p>
                 `;
                } else {
                    console.log("âœ… Bandsintown: ì•„í‹°ìŠ¤íŠ¸ ë° ê³µì—° ì •ë³´ ë Œë”ë§ë¨");
                }
            }, 3000); // 3ì´ˆ ê¸°ë‹¤ë¦° ë’¤ ì²´í¬ (ë Œë”ë§ ëŒ€ê¸° ì‹œê°„)
        });
    </script>


    <!-- ì•„í‹°ìŠ¤íŠ¸ íŒ”ë¡œìš° -->
    <script>
        // íŠ¸ë™ ì¢‹ì•„ìš”
        $(document).on('click', '#followArtistBtn', function () {
            const csrfHeader = $('meta[name="_csrf_header"]').attr('content');
            const csrfToken = $('meta[name="_csrf"]').attr('content');

            // CSRF ì„¤ì •
            $.ajaxSetup({
                beforeSend: function (xhr) {
                    xhr.setRequestHeader(csrfHeader, csrfToken);
                }
            });
            const $btn = $(this);
            const userId = $btn.data('user-id');
            const artistId = $btn.data('artist-id');

            if (!userId || userId === 0) {
                Swal.fire('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤!');
                return;
            }

            $.ajax({
                url: '/artists/toggle-like',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ userId: userId, artistId: artistId }),
                success: function (res) {
                    const followed = res.followed;
                    const count = res.count;

                    // UI ê°±ì‹ 
                    $('#followText').text(followed ? 'íŒ”ë¡œìš°â¤ï¸' : 'íŒ”ë¡œìš°ğŸ¤');
                    $('#followCount').text(count);
                },
                error: function () {
                    Swal.fire('ì¢‹ì•„ìš” ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            });
        });
    </script>

    <!-- ë¶„ìœ„ê¸°, ì•¨ë²” ê´€ë ¨ íˆ¬í‘œ -->
    <script>
        // ë¼ë””ì˜¤ë²„íŠ¼ ì²´í¬ì‹œ
        $(document).on('change', 'input[name="moodVote"]', function () {

            $('.mood-option').removeClass('selected pop-heart'); // ëª¨ë“  ë²„íŠ¼ ì´ˆê¸°í™”

            const $selected = $(this).closest('.mood-option');
            $selected.addClass('selected pop-heart'); // ì„ íƒëœ ë²„íŠ¼ì— í´ë˜ìŠ¤ ì¶”ê°€

            setTimeout(() => $selected.removeClass('pop-heart'), 300);
        });

        // ë¶„ìœ„ê¸° íˆ¬í‘œ
        $(document).on('click', '#submitMoodVote', function () {
            const selectedMood = $('input[name="moodVote"]:checked').val();
            if (!selectedMood) {
                Swal.fire('ë¶„ìœ„ê¸°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
                return;
            }

            const $container = $('#moodVoteContainer');
            const userId = $container.data('user-id');
            const artistId = $container.data('artist-id');
            const csrfHeader = $('meta[name="_csrf_header"]').attr('content');
            const csrfToken = $('meta[name="_csrf"]').attr('content');

            Swal.fire({
                title: 'ì´ ë¶„ìœ„ê¸°ë¡œ íˆ¬í‘œí• ê¹Œìš”?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'ë„¤',
                cancelButtonText: 'ì•„ë‹ˆì˜¤'
            }).then(result => {
                if (!result.isConfirmed) return;

                $.ajax({
                    url: '/artists/vote-mood',
                    type: 'POST',
                    contentType: 'application/json',
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader(csrfHeader, csrfToken);
                    },
                    data: JSON.stringify({
                        userId: userId,
                        artistId: artistId,
                        mood: selectedMood
                    }),
                    success: function (data) {
                        const votedMoodId = data.votedMoodId;
                        const tags = data.moods;
                        const values = data.values;
                        const labels = data.labels;

                        // âœ… ë¬´ë“œ ë²„íŠ¼ UI ê°±ì‹ 
                        $container.empty();
                        tags.forEach(tag => {
                            const selected = (tag.id === votedMoodId);
                            const html = `
                        <label class="btn btn-gold mood-option ${selected ? 'selected pop-heart' : ''}">
                            <input type="radio" name="moodVote" value="${tag.id}" ${selected ? 'checked' : ''} hidden />
                            <span>${tag.name}</span>
                        </label>
                    `;
                            $container.append(html);
                        });

                        const $albumMoods = $('.album-moods');
                        $albumMoods.empty();
                        if (!labels || labels.length === 0) {
                            $albumMoods.html(`
            <p id="headline">ë¶„ìœ„ê¸°ë¡œ ë…¸ë˜ì°¾ê¸°</p>
            <p style="color: var(--main-color);">ì•„ì§ ì•„ë¬´ë„ ë¶„ìœ„ê¸°ì— íˆ¬í‘œí•˜ì§€ ì•Šì•˜ì–´ìš” ğŸ˜…</p>
        `);
                        } else {
                            const moodButtons = labels.map(label => `
            <a href="/search?q=%23${encodeURIComponent(label)}">
                <button class="btn btn-gold">#${label}</button>
            </a>
        `).join('');
                            $albumMoods.html(`
            <p id="headline">ë¶„ìœ„ê¸°ë¡œ ë…¸ë˜ì°¾ê¸°</p>
            <div class="mood-list">
                ${moodButtons}
            </div>
        `);
                        }

                        // âœ… ì°¨íŠ¸ ê°±ì‹ 
                        const $chartArea = $('.chart');
                        if (!Array.isArray(values) || values.length === 0) {
                            $chartArea.html(`<p id="headline">ì•„ì§ ì•„ë¬´ë„ ë¶„ìœ„ê¸°ì— íˆ¬í‘œí•˜ì§€ ì•Šì•˜ì–´ìš” ğŸ˜…</p>`);
                        } else {
                            $chartArea.html(`<canvas id="hexRadarChart"></canvas>`);
                            renderMoodChart(labels, values);
                        }

                        setTimeout(() => {
                            $('.mood-option').removeClass('pop-heart');
                        }, 300);

                        Swal.fire('íˆ¬í‘œ ì™„ë£Œ!');
                    },
                    error: function () {
                        Swal.fire('íˆ¬í‘œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                });
            });
        });
    </script>

    <!-- ìœ¡ê° ê·¸ë˜í”„ ìŠ¤í¬ë¦½íŠ¸ -->
    <script>
        // ìœ¡ê° ì°¨íŠ¸
        function renderMoodChart(labels, values) {
            const ctx = document.getElementById('hexRadarChart').getContext('2d');

            if (window.moodChartInstance) {
                window.moodChartInstance.destroy();
            }

            const maxValue = Math.max(...values);
            const roundedMax = Math.ceil(maxValue / 10) * 10;

            // âœ… 6ê°œë¡œ ê³ ì • (ë§ìœ¼ë©´ ìë¥´ê³ , ì ìœ¼ë©´ ì±„ìš°ê¸°)
            labels = labels.slice(0, 6);
            values = values.slice(0, 6);
            while (labels.length < 6) {
                labels.push('');
                values.push(0);
            }

            window.moodChartInstance = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Mood Votes',
                        data: values,
                        backgroundColor: 'rgba(212, 185, 127, 0.2)',
                        borderColor: '#D4B97F',
                        pointBackgroundColor: '#D4B97F'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            grid: { color: '#D4B97F' },
                            angleLines: { color: '#D4B97F' },
                            pointLabels: { color: '#D4B97F' },
                            ticks: {
                                stepSize: Math.ceil(roundedMax / 5), // 4ë‹¨ê³„ë¡œ ë¶„í• 
                                backdropColor: 'transparent'
                            },
                            min: 0,
                            max: roundedMax
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
    </script>

    <script th:inline="javascript">
        const moodLabels = /*[[${moodLabels}]]*/[];
        const moodValues = /*[[${moodValues}]]*/[];

        renderMoodChart(moodLabels, moodValues);
    </script>

    <!-- ë“œë˜ê·¸ ìŠ¬ë¼ì´ë“œ -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const container = document.querySelector('.album-container');
            if (!container) return;

            /* ---------- ê¸°ì¡´ DOM ì¬êµ¬ì„± ë¶€ë¶„ ê·¸ëŒ€ë¡œ ---------- */
            const track = document.createElement('div');
            track.className = 'album-track';
            while (container.firstChild) track.appendChild(container.firstChild);
            container.appendChild(track);

            const CARD_GAP = 15;
            const card = track.querySelector('.album');
            const cardWidth = card.offsetWidth + CARD_GAP;

            /* ---------- ìë™ ìŠ¬ë¼ì´ë“œ ---------- */
            let autoSlideId = null;
            const startAutoSlide = () => {
                clearInterval(autoSlideId);
                autoSlideId = setInterval(() => {
                    if (Math.ceil(container.scrollLeft + container.offsetWidth) >= track.scrollWidth) {
                        container.scrollLeft = 0;
                    } else {
                        container.scrollLeft += cardWidth;
                    }
                }, 3000);
            };
            const stopAutoSlide = () => clearInterval(autoSlideId);
            startAutoSlide();

            /* ---------- ë“œë˜ê·¸ Â· í´ë¦­ êµ¬ë¶„ ---------- */
            const THRESHOLD = 5;        // 5px ì´í•˜ë©´ â€œí´ë¦­â€, ì´ˆê³¼ë©´ â€œë“œë˜ê·¸â€
            let isDown = false;     // ëˆ„ë¥¸ ìƒíƒœ
            let startX = 0;         // ëˆ„ë¥¸ ì§€ì 
            let scrollLeft = 0;         // ì›ë˜ ìŠ¤í¬ë¡¤ ê°’
            let moved = 0;         // ì´ë™ ê±°ë¦¬ ëˆ„ì 

            const dragStart = (x) => {
                isDown = true;
                moved = 0;
                startX = x - container.offsetLeft;
                scrollLeft = container.scrollLeft;
                container.classList.add('grabbing');
                stopAutoSlide();
            };

            const dragMove = (x) => {
                if (!isDown) return;
                const xPos = x - container.offsetLeft;
                const walk = xPos - startX;     // (+ â†’ ì˜¤ë¥¸ìª½, â€“ â†’ ì™¼ìª½)
                moved = Math.max(moved, Math.abs(walk));
                container.scrollLeft = scrollLeft - walk;
            };

            const dragEnd = () => {
                isDown = false;
                container.classList.remove('grabbing');
                startAutoSlide();
            };

            /* ---------- ë§ˆìš°ìŠ¤/í„°ì¹˜ ì´ë²¤íŠ¸ ---------- */
            // â†“ ë§ˆìš°ìŠ¤
            container.addEventListener('mousedown', (e) => {
                dragStart(e.pageX);
                e.preventDefault();
            });
            window.addEventListener('mousemove', (e) => dragMove(e.pageX));
            window.addEventListener('mouseup', dragEnd);

            // â†“ í„°ì¹˜
            container.addEventListener('touchstart', (e) => dragStart(e.touches[0].pageX), { passive: true });
            container.addEventListener('touchmove', (e) => dragMove(e.touches[0].pageX), { passive: false });
            container.addEventListener('touchend', dragEnd);

            /* ---------- í´ë¦­ ì·¨ì†Œ ë¡œì§ ---------- */
            container.addEventListener('click', (e) => {
                if (moved > THRESHOLD) {   // ë°©ê¸ˆ ì „ ë™ì‘ì´ â€œë“œë˜ê·¸â€ì˜€ë‹¤ë©´
                    e.preventDefault();      // a íƒœê·¸ ë§í¬ ì´ë™ ë§‰ê¸°
                    e.stopPropagation();
                }
                // moved â‰¤ 5px ì´ë©´ í´ë¦­ìœ¼ë¡œ ê°„ì£¼ â†’ ë§í¬ ì •ìƒ ì‘ë™
            });

            /* ---------- í˜¸ë²„ ì‹œ ìë™ ìŠ¬ë¼ì´ë“œ ì œì–´ ---------- */
            container.addEventListener('mouseenter', stopAutoSlide);
            container.addEventListener('mouseleave', startAutoSlide);
        });

    </script>

</body>

</html>