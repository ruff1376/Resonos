<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{/layouts/main_layout}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="|${album.title} ë¦¬ë·°|">ì•¨ë²” ë¦¬ë·°</title>
    <th:block th:replace="~{fragments/link::album}"></th:block>
</head>

<body layout:fragment="content">
    <div class="wrapper">
        <!-- ì•¨ë²” ì¹´ë“œ -->
        <div class="song-card">
            <div class="song-overall">
                <div class="song-img">
                    <img th:src="@{${album.coverImage}}" alt="">
                    <span class="center-pin"></span>
                </div>
            </div>
            <div class="song-info">
                <p id="headline" th:text="${album.title}">ì•¨ë²”ì œëª©</p>
                <p th:text="${#dates.format(album.releaseDate, 'yyyy-MM-dd')}">ë°œë§¤ì¼</p>
                <a th:href="@{artists(id=${artist.id})}">
                    <p th:text="${artist.name}">ì•„í‹°ìŠ¤íŠ¸ ì´ë¦„</p>
                </a>
                <p th:text="${album.label}">ë ˆì´ë¸”</p>
                <div class="review-section">
                    <th:block th:replace="~{review/reviewFrag :: reviewSection(score=${score})}"></th:block>
                </div>
                <div style="display: flex; gap: 15px;">
                    <button type="button" class="btn btn-gold like-album-btn" th:data-album-id="${album.id}"
                        th:data-user-id="${loginUser != null ? loginUser.id : 0}" th:data-liked="${isAlbumLikedByUser}">
                        <span class="like-text"
                            th:text="${isAlbumLikedByUser != null and isAlbumLikedByUser ? 'ì¢‹ì•„ìš”â¤ï¸' : 'ì¢‹ì•„ìš”ğŸ¤'}"></span>
                        <span class="like-count" th:text="${albumLikeCount}">0</span>
                    </button>
                </div>
            </div>

            <div class="track-graphy">
                <div class="track-header">
                    <p id="headline" th:text="|${album.title}ğŸ’½ Tracks|">ìˆ˜ë¡ê³¡</p>
                </div>
                <div class="track-container">
                    <!-- ë°˜ë³µë¬¸ êµ¬ê°„ -->
                    <th:block th:each="track : ${tracks}">
                        <a th:href="@{tracks(id=${track.id})}">
                            <div class="track">
                                <div class="track-img">
                                    <img th:src="@{${album.coverImage}}" alt="">
                                    <span class="center-pin"></span>
                                </div>
                                <div class="track-info">
                                    <p id="subtitle" th:text="${track.title}">íŠ¸ë™ëª…</p>
                                    <p th:text="|${track.formattedDuration}|">ê³¡ê¸¸ì´</p>
                                    <p th:text="|${track.trackNo}th Track|">ë²ˆì§¸ê³¡</p>
                                </div>
                            </div>
                        </a>
                    </th:block>
                </div>
            </div>
        </div>
        <!-- ì•¨ë²” ì¹´ë“œ ë -->

        <!-- iframe -->
        <div class="iframe-card">
            <div class="spotify">
                <!-- ìŠ¤í¬í‹°íŒŒì´ ë¡œê·¸ì¸ ë˜ì–´ìˆì§€ì•Šì„ë•Œ 30ì´ˆ ë¯¸ë¦¬ë“£ê¸° ì˜¤ë””ì˜¤íƒœê·¸ -->
                <iframe th:src="|https://open.spotify.com/embed/track/${track.id}?utm_source=generator|" frameborder="0"
                    allowfullscreen allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
                    loading="lazy">
                </iframe>
            </div>
            <div class="youtube">
                <th:block th:if="${!#strings.isEmpty(track.mvUrl)}">
                    <iframe width="560" height="315" th:src="|https://www.youtube.com/embed/${track.mvUrl}|"
                        title="YouTube video player" frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                        referrerpolicy="strict-origin-when-cross-origin" allowfullscreen>
                    </iframe>
                </th:block>
                <!-- â‘¡ MV URLì´ ì—†ì„ ë•Œ â†’ ì¤€ë¹„ì¤‘ ì´ë¯¸ì§€ -->
                <th:block th:if="${#strings.isEmpty(track.mvUrl)}">
                    <img th:src="@{/img/wait_plz.png}" alt="ë®¤ì§ë¹„ë””ì˜¤ ì¤€ë¹„ì¤‘" width="560" height="315"
                        style="object-fit:cover;">
                </th:block>
            </div>
        </div>
        <!-- iframe ì¹´ë“œ ë -->

        <!-- ì•¨ë²” íŠ¸ë™ë¦¬ìŠ¤íŠ¸ ë¶„ìœ„ê¸° ë­ë­.. -->
        <div class="info-card">
            <div class="info top5track">
                <p id="headline" th:text="|${album.title}ğŸ’½ TOP${#lists.size(top5List)}ğŸ”¥|">ì•¨ë²” ì¸ê¸° TOP 5 íŠ¸ë™</p>
                <th:block th:each="tops, stat : ${top5List}">
                    <a th:href="@{tracks(id=${tops.id})}">
                        <p th:text="|${stat.count}. ${tops.title} ${track.formattedDuration}|"></p>
                    </a>
                </th:block>
            </div>
            <div class="info album-moods">
                <p id="headline">ì•¨ë²”ì˜ í‰ê·  ì ìˆ˜</p>
                <th:block th:if="${argScores == null or argScores.isEmpty()}">
                    <p>ì•„ì§ ì•„ë¬´ë„ íˆ¬í‘œí•˜ì§€ ì•Šì•˜ì–´ìš”</p>
                </th:block>
                <th:block th:if="${argScores != null and !argScores.isEmpty()}">
                    <div class="score-info">
                        <div>
                            <p>ê°€ì‚¬ : </p><span th:text="${argScores[0]}">ê°€ì‚¬:100ì </span>
                        </div>
                        <div>
                            <p>ì‚¬ìš´ë“œ : </p><span th:text="${argScores[1]}">ê°€ì‚¬:100ì </span>
                        </div>
                        <div>
                            <p>ë©œë¡œë”” : </p><span th:text="${argScores[2]}">ê°€ì‚¬:100ì </span>
                        </div>
                        <div>
                            <p>ìŠ¤í† ë¦¬í…”ë§ : </p><span th:text="${argScores[3]}">ê°€ì‚¬:100ì </span>
                        </div>
                        <div>
                            <p>ìœ ê¸°ì„± : </p><span th:text="${argScores[4]}">ê°€ì‚¬:100ì </span>
                        </div>
                        <div>
                            <p>ë…ì°½ì„± : </p><span th:text="${argScores[5]}">ê°€ì‚¬:100ì </span>
                        </div>
                    </div>
                </th:block>
            </div>
            <div class="info pl-list">
                <p id="subtitle" th:text="|${album.title}ì˜ íŠ¸ë™ì´ í¬í•¨ëœ í”Œë¦¬ğŸ¶|">ì´ íŠ¸ë™ì„ í¬í•¨í•œ í”Œë¦¬ğŸ¶</p>
                <th:block th:if="${emptyPlayList == true || playLists.isEmpty()}">
                    <p>í•´ë‹¹ ìŒì›ì„ í¬í•¨í•œ</p>
                    <p>í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”! ğŸ¤©</p>
                </th:block>
                <th:block th:each="playList : ${playLists}">
                    <p th:text="|${playList.title} â¤ï¸${playList.likeCount}|"></p>
                </th:block>
            </div>
        </div>
        <!-- ì•¨ë²” íŠ¸ë™ë¦¬ìŠ¤íŠ¸ ë¶„ìœ„ê¸° ë­ë­..ë -->

        <!-- í‰ì &ë¦¬ë·° -->
        <div class="review-card">
            <p id="headline">í‰ì  & ë¦¬ë·°</p>
            <div th:fragment="scoreFragment">
                <div class="review-score">
                    <th:block th:if="${score == null or score.averageScore == null}">
                        <h1 id="headline" style="padding: 10px;">ì²« ë¦¬ë·°ë¥¼ ì‘ì„±í•´ë³´ì„¸ìš” ğŸ¤©</h1>
                    </th:block>
                    <th:block th:if="${score != null and score.averageScore != null}">
                        <h1 id="headline" th:text="|ğŸ”® ${#numbers.formatDecimal(score.averageScore, 0, 0)}|"></h1>
                        <div class="score-bar">
                            <div class="score-fill"
                                th:style="'width:' + ${#numbers.formatDecimal(score.averageScore, 1, 1)} + '%'">
                                <span th:text="${#numbers.formatDecimal(score.averageScore, 0, 0)}"></span>
                            </div>
                        </div>
                    </th:block>
                </div>
            </div>
            <div class="review-container">
                <ul class="review-list" th:insert="~{review/reviewFrag :: reviewItems(review=${review})}"></ul>
                <!-- ë”ë³´ê¸° ë²„íŠ¼ -->
                <div class="d-flex justify-content-center mb-1">
                    <div class="more-box d-flex gap-3" th:if="${hasNext}">
                        <button id="load-more-btn" data-page="1" th:data-album-id="${album.id}" class="btn btn-gold">ë¦¬ë·°
                            ë”ë³´ê¸°</button>
                    </div>
                </div>
                <th:block th:if="${loginUser == null}">
                    <div class="d-flex gap-3 align-items-center">
                        <p id="headline" style="padding: 10px; margin-bottom: 0px">ë¡œê·¸ì¸ì‹œ ë¦¬ë·°ì‘ì„±ê³¼ ì ìˆ˜íˆ¬í‘œê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
                        <a id="login-review" href="/login" class="btn btn-gold">ë¡œê·¸ì¸</a>
                    </div>
                </th:block>
            </div>
            <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
            <div th:if="${loginUser != null}" class="reply">
                <form id="reviewForm">
                    <input type="hidden" id="albumId" th:value="${album.id}">
                    <textarea id="content" placeholder="ë¦¬ë·°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”" required></textarea>
                    <div class="score-and-submit">
                        <input type="number" id="rating" min="0" max="100" placeholder="0~100ì " required>
                        <button type="submit" class="btn btn-gold">ë¦¬ë·°ì‘ì„±</button>
                    </div>
                </form>
            </div>
        </div>
        <!-- í‰ì &ë¦¬ë·° ë -->

        <!-- ìš”ì†Œ íˆ¬í‘œ -->
        <div class="arg-card">
            <div class="chart">
                <th:block th:if="${argScores == null or argScores.isEmpty()}">
                    <p id="headline">ì•„ì§ ì•„ë¬´ë„ íˆ¬í‘œí•˜ì§€ ì•Šì•˜ì–´ìš”</p>
                </th:block>
                <th:block th:if="${argScores != null and !argScores.isEmpty()}">
                    <canvas id="hexRadarChart"></canvas>
                </th:block>
            </div>
            <div class="arg-vote" th:data-album-id="${album.id}" th:data-user-id="${loginUser?.id}">
                <div class="vote-header">
                    <p id="headline">6ìš”ì†Œ í‰ê°€</p>
                </div>
                <!-- í‰ê°€ ì¶œë ¥ (ê¸°ì¡´ ì ìˆ˜) -->
                <th:block th:if="${loginUser == null}">
                    <p id="headline">ë¡œê·¸ì¸í›„ ì ìˆ˜íˆ¬í‘œê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤</p>
                </th:block>
                <div class="d-flex gap-5">
                    <div id="vote-result-view" class="vote-result-view">
                        <ul>
                            <li><span>ê°€ì‚¬ : </span><span id="lyric-view">-</span></li>
                            <li><span>ì‚¬ìš´ë“œ : </span><span id="sound-view">-</span></li>
                            <li><span>ë©œë¡œë”” : </span><span id="melody-view">-</span></li>
                            <li><span>ìŠ¤í† ë¦¬í…”ë§ : </span><span id="storytelling-view">-</span></li>
                            <li><span>ìœ ê¸°ì„± : </span><span id="cohesiveness-view">-</span></li>
                            <li><span>ë…ì°½ì„± : </span><span id="creativity-view">-</span></li>
                        </ul>
                        <button id="edit-btn" class="btn btn-gold">ìˆ˜ì •</button>
                    </div>
                    <!-- í‰ê°€ í¼ (ì…ë ¥ìš©) -->
                    <form id="vote-form" class="vote-form">
                        <div class="vote-row">
                            <label class="vote-label">ê°€ì‚¬</label>
                            <input type="range" id="lyric-slider" name="lyric" min="0" max="100" value="50"
                                style="vertical-align: middle;">
                            <input type="number" id="lyric-input" name="lyricInput" min="0" max="100" value="50">
                            <br>
                        </div>
                        <div class="vote-row">
                            <label class="vote-label">ì‚¬ìš´ë“œ</label>
                            <input type="range" id="sound-slider" name="sound" min="0" max="100" value="50"
                                style="vertical-align: middle;">
                            <input type="number" id="sound-input" name="soundInput" min="0" max="100" value="50">
                            <br>
                        </div>
                        <div class="vote-row">
                            <label class="vote-label">ë©œë¡œë””</label>
                            <input type="range" id="melody-slider" name="melody" min="0" max="100" value="50"
                                style="vertical-align: middle;">
                            <input type="number" id="melody-input" name="melodyInput" min="0" max="100" value="50">
                            <br>
                        </div>
                        <div class="vote-row">
                            <label class="vote-label">ìŠ¤í† ë¦¬í…”ë§</label>
                            <input type="range" id="storytelling-slider" name="storytelling" min="0" max="100"
                                value="50" style="vertical-align: middle;">
                            <input type="number" id="storytelling-input" name="storytellingInput" min="0" max="100"
                                value="50">
                            <br>
                        </div>
                        <div class="vote-row">
                            <label class="vote-label">ìœ ê¸°ì„±</label>
                            <input type="range" id="cohesiveness-slider" name="cohesiveness" min="0" max="100"
                                value="50" style="vertical-align: middle;">
                            <input type="number" id="cohesiveness-input" name="cohesivenessInput" min="0" max="100"
                                value="50">
                            <br>
                        </div>
                        <div class="vote-row">
                            <label class="vote-label">ë…ì°½ì„±</label>
                            <input type="range" id="creativity-slider" name="creativity" min="0" max="100" value="50"
                                style="vertical-align: middle;">
                            <input type="number" id="creativity-input" name="creativityInput" min="0" max="100"
                                value="50">
                            <br>
                        </div>
                        <button type="button" id="save-btn" class="btn btn-gold">ì €ì¥</button>
                    </form>
                </div>
                <div></div>
            </div>

        </div>
        <!-- ìš”ì†Œ íˆ¬í‘œ ë -->


    </div>
    <script th:inline="javascript">
        const isLogin = [[${ loginUser != null ? 'true' : 'false'}]];
    </script>

    <!-- í•´ë‹¹ ëŒ“ê¸€ë¡œ ìŠ¤í¬ë¡¤ ì´ë™ -->
    <script>
        /* í•´ë‹¹ ëŒ“ê¸€ë¡œ ìŠ¤í¬ë¡¤ ì´ë™ */
        document.addEventListener("DOMContentLoaded", function () {
            const params = new URLSearchParams(window.location.search);
            const reviewId = params.get("reviewId");

            if (reviewId) {
                const target = document.querySelector(`[data-review-id="${reviewId}"]`);
                if (target) {
                    target.scrollIntoView({
                        behavior: "smooth",
                        block: "center"
                    });
                    target.style.transition = 'background 0.3s';
                    target.style.background = 'rgba(255,255,255,0.3)';
                    target.scroll
                    setTimeout(() => target.style.background = '', 1500);
                }
            }
        });
    </script>

    <!-- ë¡œê·¸ì¸ì‹œ ì›ë˜í˜ì´ì§€ë¡œ -->
    <script>
        document.getElementById('login-review').addEventListener('click', e => {
            e.preventDefault()
            sessionStorage.setItem('returnTo', location.href)
            location.href = '/login'
        })
    </script>
    <!-- ë“œë˜ê·¸ ìŠ¬ë¼ì´ë“œ ìë°”ìŠ¤í¬ë¦½íŠ¸ -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const container = document.querySelector('.track-container');
            if (!container) return;

            /* ì¹´ë“œ í•˜ë‚˜ + gap = 270 + 20 */
            const STEP = 290;
            const THRESHOLD = 5;    // í´ë¦­Â·ë“œë˜ê·¸ êµ¬ë¶„
            const INTERVAL = 3000; // ìë™ ìŠ¬ë¼ì´ë“œ ê°„ê²©(ms)

            /* â”€â”€â”€ ìë™ ìŠ¬ë¼ì´ë“œ â”€â”€â”€ */
            let autoId = null;
            const startAuto = () => {
                clearInterval(autoId);
                autoId = setInterval(() => {
                    const max = container.scrollWidth - container.clientWidth;
                    const atEnd = Math.ceil(container.scrollLeft) >= max;
                    container.scrollTo({ left: atEnd ? 0 : container.scrollLeft + STEP, behavior: 'smooth' });
                }, INTERVAL);
            };
            const stopAuto = () => clearInterval(autoId);

            /* â”€â”€â”€ ë“œë˜ê·¸ ë³€ìˆ˜ â”€â”€â”€ */
            let down = false, startX = 0, startScroll = 0, moved = 0;

            const dragStart = x => {
                down = true; moved = 0;
                startX = x - container.offsetLeft;
                startScroll = container.scrollLeft;
                container.classList.add('grabbing');
                stopAuto();
            };
            const dragMove = x => {
                if (!down) return;
                const delta = (x - container.offsetLeft) - startX;
                moved = Math.max(moved, Math.abs(delta));
                container.scrollLeft = startScroll - delta;
            };
            const dragEnd = () => {
                if (!down) return;
                down = false; container.classList.remove('grabbing');

                /* ìŠ¤ëƒ… ìœ„ì¹˜ ë³´ì • */
                const rest = container.scrollLeft % STEP;
                const target = rest > STEP / 2
                    ? container.scrollLeft + (STEP - rest)
                    : container.scrollLeft - rest;
                container.scrollTo({ left: target, behavior: 'smooth' });
                startAuto();
            };

            /* â”€â”€â”€ ì´ë²¤íŠ¸ â”€â”€â”€ */
            // ë§ˆìš°ìŠ¤
            container.addEventListener('mousedown', e => { dragStart(e.pageX); e.preventDefault(); });
            window.addEventListener('mousemove', e => dragMove(e.pageX));
            window.addEventListener('mouseup', dragEnd);

            // í„°ì¹˜
            container.addEventListener('touchstart', e => dragStart(e.touches[0].pageX), { passive: true });
            container.addEventListener('touchmove', e => dragMove(e.touches[0].pageX), { passive: false });
            container.addEventListener('touchend', dragEnd);

            // í´ë¦­ vs ë“œë˜ê·¸
            container.addEventListener('click', e => {
                if (moved > THRESHOLD) { e.preventDefault(); e.stopPropagation(); }
            });

            // í˜¸ë²„ ì‹œ ìë™ ìŠ¬ë¼ì´ë“œ ì¼ì‹œ ì •ì§€ (PC)
            container.addEventListener('mouseenter', stopAuto);
            container.addEventListener('mouseleave', startAuto);

            startAuto();      // ìµœì´ˆ ì‹¤í–‰
        });
    </script>
    <!-- ë¹„ë™ê¸° crud ê¸°ëŠ¥ -->
    <script>
        $(document).ready(function () {
            const csrfHeader = $('meta[name="_csrf_header"]').attr('content');
            const csrfToken = $('meta[name="_csrf"]').attr('content');

            // CSRF ì„¤ì •
            $.ajaxSetup({
                beforeSend: function (xhr) {
                    xhr.setRequestHeader(csrfHeader, csrfToken);
                }
            });

            // ì ìˆ˜ ë°•ìŠ¤ ê°±ì‹ 
            function reloadScoreBox(albumId) {
                $.ajax({
                    url: `/albums/${albumId}/score-fragment`,
                    type: 'GET',
                    success: function (html) {
                        $('.review-score').html(html);
                    },
                    error: function () {
                        console.error("ì ìˆ˜ ê°±ì‹  ì‹¤íŒ¨");
                    }
                });
            }

            /** â‘  ë“±ë¡ */
            $('#reviewForm').on('submit', function (e) {
                e.preventDefault();

                const albumId = $('#albumId').val();
                const content = $('#content').val().trim();
                const rating = $('#rating').val();

                if (content === '' || rating === '') {
                    Swal.fire('ë¦¬ë·°ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”', 'ë¦¬ë·°ë¥¼ ì…ë ¥í•˜ì§€ ì•Šìœ¼ì…¨ìŠµë‹ˆë‹¤.', 'error');
                    return;
                }

                $.ajax({
                    url: `/albums?id=${albumId}`,
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ content, rating }),
                    success: function () {
                        Swal.fire({
                            title: 'ì„±ê³µ',
                            text: 'ë¦¬ë·°ë¥¼ ë“±ë¡ í•˜ì˜€ìŠµë‹ˆë‹¤.',
                            icon: 'success',
                            confirmButtonText: 'í™•ì¸'
                        }).then(() => {
                            $('#reviewForm').trigger('reset');
                            // 1. ì ìˆ˜ ë°•ìŠ¤ ë¦¬ë¡œë“œ
                            reloadScoreBox(albumId);

                            // 2. review-section í”„ë˜ê·¸ë¨¼íŠ¸ ê°±ì‹ 
                            $.get(`/albums/${albumId}/refresh-frag`, function (html) {
                                const $html = $('<div>').html(html);
                                const $newSection = $html.find('.review-section');

                                if ($newSection.length) {
                                    $('.song-info .review-section').replaceWith($newSection);
                                }
                            });

                            // 3. ë‚´ ë¦¬ë·° í”„ë˜ê·¸ë¨¼íŠ¸ ì¶”ê°€
                            $.get(`/albums/${albumId}/my-review-frag`, function (html) {
                                const $html = $('<div>').html(html);
                                const $newReview = $html.find('li.comment');

                                if ($newReview.length) {
                                    $newReview.hide();
                                    $('.review-list').append($newReview);
                                    $newReview.slideDown();
                                }
                            });
                        });
                    },
                    error: function (xhr) {
                        if (xhr.status === 409) {
                            Swal.fire('ì¤‘ë³µ', 'ì´ë¯¸ ë¦¬ë·°ë¥¼ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.', 'warning');
                        } else {
                            Swal.fire('ì˜¤ë¥˜', 'ë¦¬ë·° ë“±ë¡ ì¤‘ ì˜¤ë¥˜ ë°œìƒ.', 'error');
                        }
                    }
                });
            });

            /** â‘¡ ìˆ˜ì • ë²„íŠ¼ í´ë¦­ â†’ í¼ ì—´ê¸° + ê¸°ì¡´ ë‚´ìš© ì±„ìš°ê¸° */
            $(document).on('click', '.edit-btn', function (e) {
                e.preventDefault();

                const li = $(this).closest('li');
                const reviewId = li.attr('data-review-id');
                const albumId = li.attr('data-album-id');
                const contentText = li.find('.content-text');
                const content = contentText.text().trim();
                const rating = li.find('.name-and-score span span').text().trim();

                contentText.slideUp(200);
                li.find('.edit-content').val(content);
                li.find('.edit-rating').val(rating);
                li.find('.edit-form').slideDown();
            });

            /** â‘¢ ìˆ˜ì • ì™„ë£Œ â†’ PUT ìš”ì²­ */
            $(document).on('submit', '.edit-form', function (e) {
                e.preventDefault();

                const form = $(this);
                const li = form.closest('li');
                const reviewId = li.attr('data-review-id');
                const albumId = li.attr('data-album-id');
                const content = form.find('.edit-content').val().trim();
                const rating = form.find('.edit-rating').val();

                if (content === '' || rating === '') {
                    Swal.fire('ë¦¬ë·°ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”', 'ë¦¬ë·°ë¥¼ ì…ë ¥í•˜ì§€ ì•Šìœ¼ì…¨ìŠµë‹ˆë‹¤.', 'error');
                    return;
                }

                $.ajax({
                    url: `/albums/${albumId}/review/${reviewId}`,
                    method: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify({ content, rating }),
                    success: function (updated) {
                        li.find('.content-text').text(updated.content).slideDown();
                        li.find('.name-and-score span span').text(updated.rating);
                        form.slideUp();
                        reloadScoreBox(albumId);
                    },
                    error: function (xhr) {
                        console.error(xhr.responseText);
                        Swal.fire('ì˜¤ë¥˜', 'ë¦¬ë·° ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ ë°œìƒ.', 'error');
                    }
                });
            });

            /** â‘£ ìˆ˜ì • ì·¨ì†Œ */
            $(document).on('click', '.btn-danger', function () {
                const form = $(this).closest('.edit-form');
                const li = form.closest('li');
                form.slideUp();
                li.find('.content-text').slideDown();
            });

            /** â‘¤ ì‚­ì œ */
            $(document).on('click', '.del-btn', function (e) {
                e.preventDefault();

                const li = $(this).closest('li');
                const reviewId = li.data('review-id');
                const albumId = li.data('album-id');

                Swal.fire({
                    title: 'ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
                    text: 'ì‚­ì œëœ ë¦¬ë·°ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'ì‚­ì œ',
                    cancelButtonText: 'ì·¨ì†Œ'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            url: `/albums/${albumId}/review/${reviewId}`,
                            method: 'DELETE',
                            success: function (html) {
                                li.slideUp(() => li.remove());
                                reloadScoreBox(albumId);
                                $('.song-info .review-section').replaceWith(html);
                                Swal.fire({
                                    title: 'ì‚­ì œ ì™„ë£Œ',
                                    text: 'ë¦¬ë·°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.',
                                    icon: 'success',
                                    confirmButtonText: 'í™•ì¸'
                                });
                            },
                            error: function (xhr) {
                                console.error(xhr.responseText);
                                Swal.fire('ì˜¤ë¥˜', 'ë¦¬ë·° ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ.', 'error');
                            }
                        });
                    }
                });
            });
        });

    </script>

    <!-- ë¦¬ë·° ì¢‹ì•„ìš”, ì‹ ê³  ë¹„ë™ê¸° -->
    <script>
        // ë¦¬ë·° ì¢‹ì•„ìš”
        $(document).on("click", ".like-btn", function () {
            if (!isLogin) {
                Swal.fire({
                    title: 'ë¡œê·¸ì¸ì„ í•´ì£¼ì„¸ìš”',
                    text: 'ë¡œê·¸ì¸ì‹œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.',
                    icon: 'error',
                    confirmButtonText: 'í™•ì¸'
                });
                return;
            }

            const btn = $(this);
            const reviewId = btn.data("review-id");
            const reviewType = btn.data("review-type");

            $.post(`/albums/${reviewType.toLowerCase()}-reviews/${reviewId}/like`, {}, function (data) {
                btn.data("liked", data.liked);
                btn.text(data.liked ? 'â¤ï¸' : 'ğŸ¤');

                // í•˜íŠ¸ ì• ë‹ˆë©”ì´ì…˜
                btn.addClass("pop-heart");
                setTimeout(() => btn.removeClass("pop-heart"), 300);

                // ì¢‹ì•„ìš” ìˆ˜ ê°±ì‹ 
                const countEl = $("#like-count-" + reviewId);
                const currentCount = parseInt(countEl.text(), 10);

                if (currentCount !== data.likeCount) {
                    countEl.slideUp(150, function () {
                        countEl.text(data.likeCount).slideDown(150);
                    });
                }
            }).fail(function () {
                Swal.fire({
                    title: 'ë¡œê·¸ì¸ì„ í•´ì£¼ì„¸ìš”',
                    text: 'ë¡œê·¸ì¸ì‹œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.',
                    icon: 'error',
                    confirmButtonText: 'í™•ì¸'
                });
            });
        });

        // ì‹ ê³ 
        $(document).on("click", ".report-btn", function () {
            if (!isLogin) {
                Swal.fire({
                    title: "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤",
                    text: "ì‹ ê³ í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.",
                    icon: "warning",
                    confirmButtonText: "í™•ì¸"
                });
                return;
            }

            const reviewId = $(this).data("review-id");
            const reviewType = $(this).data("review-type");

            Swal.fire({
                title: "ì‹ ê³ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?",
                text: "í•´ë‹¹ ë¦¬ë·°ë¥¼ ì‹ ê³ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?",
                icon: "question",
                showCancelButton: true,
                confirmButtonText: "ì‹ ê³ ",
                cancelButtonText: "ì·¨ì†Œ"
            }).then((result) => {
                if (result.isConfirmed) {
                    $.post(`/albums/reviews/${reviewType}/${reviewId}/report`, {}, function (data) {
                        Swal.fire({
                            title: "ì‹ ê³  ì™„ë£Œ",
                            text: `ì´ ì‹ ê³  ìˆ˜: ${data.reportCount}`,
                            icon: "success",
                            confirmButtonText: "í™•ì¸"
                        });
                    }).fail(function (xhr) {
                        if (xhr.status === 429) {
                            Swal.fire("ì¤‘ë³µ ì‹ ê³ ", "ì´ë¯¸ ì‹ ê³ í•œ ë¦¬ë·°ì…ë‹ˆë‹¤.", "warning");
                        } else if (xhr.status === 401) {
                            Swal.fire("ë¡œê·¸ì¸ í•„ìš”", "ì‹ ê³ í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.", "warning");
                        } else {
                            Swal.fire("ì˜¤ë¥˜", "ì‹ ê³  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "error");
                        }
                    });
                }
            });
        });

        // ë¦¬ë·° ë”ë³´ê¸°
        $(document).ready(function () {
            $('#load-more-btn').on('click', function () {
                const $btn = $(this);
                let page = parseInt($btn.data('page'));
                const albumId = $btn.data('album-id');
                const size = 5;

                const nextPage = page + 1;

                $.ajax({
                    url: `/albums/${albumId}/reviews/more`,
                    type: 'GET',
                    data: { page: nextPage, size: size },
                    success: function (fragmentHtml) {
                        const $fragment = $('<div>').html(fragmentHtml);
                        $('.review-list').append($fragment.find('li.comment'));

                        const $hasNextFlag = $fragment.find('#has-next-flag');
                        const hasNextRaw = $hasNextFlag.data('has-next');
                        const hasNext = hasNextRaw === true || hasNextRaw === 'true';

                        $hasNextFlag.remove();

                        if (hasNext) {
                            $btn.data('page', nextPage);
                        } else {
                            $btn.hide();
                        }
                    },
                    error: function () {
                        alert('ë¦¬ë·°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    }
                });
            });
        });
    </script>

    <!-- ë¶„ìœ„ê¸°, ì•¨ë²” ê´€ë ¨ íˆ¬í‘œ -->
    <script>
        // 6ìš”ì†Œ íˆ¬í‘œ
        $(document).ready(function () {
            const $argVote = $('.arg-vote');
            const albumId = $argVote.data('album-id');
            const userId = $argVote.data('user-id');
            const fields = ['lyric', 'sound', 'melody', 'storytelling', 'cohesiveness', 'creativity'];
            let isUpdate = false;
            let isEditing = false; // í¼ ì—´ë¦¼ ì—¬ë¶€

            function syncSliderAndInput(field) {
                $(`#${field}-slider`).on('input', function () {
                    $(`#${field}-input`).val(this.value);
                });
                $(`#${field}-input`).on('input', function () {
                    let val = parseInt(this.value) || 0;
                    val = Math.max(0, Math.min(100, val));
                    $(`#${field}-slider`).val(val);
                    $(this).val(val);
                });
            }

            fields.forEach(syncSliderAndInput);

            $('#vote-result-view').hide();
            $('#vote-form').hide();

            if (!userId) return;

            // ìœ ì € í‰ê°€ ë¶ˆëŸ¬ì˜¤ê¸°
            $.get('/albums/chart/user', { userId, albumId }, function (data) {
                $('#vote-result-view').show();

                if (data && data.lyric != null) {
                    isUpdate = true;
                    fields.forEach(field => {
                        $(`#${field}-view`).text(data[field]);
                        $(`#${field}-slider`).val(data[field]);
                        $(`#${field}-input`).val(data[field]);
                    });
                    $('#edit-btn').text('ìˆ˜ì •í•˜ê¸°');
                } else {
                    $('#edit-btn').text('íˆ¬í‘œí•˜ê¸°');
                    fields.forEach(field => $(`#${field}-view`).text('-'));
                }
            });

            // ìˆ˜ì • / ì·¨ì†Œ ë²„íŠ¼
            $('#edit-btn').on('click', function () {
                const $form = $('#vote-form');

                if (isEditing) {
                    // ë‹«ê¸°
                    $form.removeClass('active');
                    $('#edit-btn').text(isUpdate ? 'ìˆ˜ì •í•˜ê¸°' : 'íˆ¬í‘œí•˜ê¸°');
                    isEditing = false;

                    // íŠ¸ëœì§€ì…˜ ëë‚œ í›„ì— ìˆ¨ê¹€ ì²˜ë¦¬
                    setTimeout(() => $form.hide(), 400);
                } else {
                    $form.show(); // ë¨¼ì € block ì²˜ë¦¬
                    void $form[0].offsetWidth; // âœ… reflow ê°•ì œ (transition ë™ì‘ ìœ ë„)
                    $form.addClass('active');
                    $('#edit-btn').text('ì·¨ì†Œ');
                    isEditing = true;
                }
            });

            // ì €ì¥
            $('#save-btn').on('click', function () {
                const payload = { albumId, userId };
                fields.forEach(field => {
                    payload[field] = parseInt($(`#${field}-input`).val()) || 0;
                });

                $.ajax({
                    type: 'POST',
                    url: '/albums/vote',
                    contentType: 'application/json',
                    data: JSON.stringify(payload),
                    success: function () {
                        const msg = isUpdate ? 'ìˆ˜ì • ì™„ë£Œ!' : 'íˆ¬í‘œ ì™„ë£Œ!';
                        isUpdate = true;

                        fields.forEach(field => {
                            $(`#${field}-view`).text(payload[field]);
                            $(`#${field}-slider`).val(payload[field]);
                            $(`#${field}-input`).val(payload[field]);
                        });

                        $('#vote-result-view').show();

                        // í¼ ìŠ¬ë¼ì´ë“œë¡œ ë‹«ê¸°
                        const $form = $('#vote-form');
                        $form.removeClass('active');
                        setTimeout(() => $form.hide(), 400);
                        $('#edit-btn').text('ìˆ˜ì •í•˜ê¸°');
                        isEditing = false;

                        // ì°¨íŠ¸ ê°±ì‹ 
                        $.get('/albums/chart/average', { albumId }, function (avg) {
                            const argLabels = ['ê°€ì‚¬', 'ì‚¬ìš´ë“œ', 'ë©œë¡œë””', 'ìŠ¤í† ë¦¬í…”ë§', 'ìœ ê¸°ì„±', 'ë…ì°½ì„±'];
                            const argScores = [
                                avg.lyric ?? 0,
                                avg.sound ?? 0,
                                avg.melody ?? 0,
                                avg.storytelling ?? 0,
                                avg.cohesiveness ?? 0,
                                avg.creativity ?? 0
                            ];
                            const $moodsBox = $('.album-moods');
                            let $infoBox = $moodsBox.find('.score-info');

                            if ($infoBox.length === 0) {
                                // ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±í•´ì„œ ì‚½ì… (headline ë°”ë¡œ ë’¤ì—)
                                $infoBox = $(`
                                    <div class="score-info">
                                        <div><p>ê°€ì‚¬ : </p><span>${argScores[0]}</span></div>
                                        <div><p>ì‚¬ìš´ë“œ : </p><span>${argScores[1]}</span></div>
                                        <div><p>ë©œë¡œë”” : </p><span>${argScores[2]}</span></div>
                                        <div><p>ìŠ¤í† ë¦¬í…”ë§ : </p><span>${argScores[3]}</span></div>
                                        <div><p>ìœ ê¸°ì„± : </p><span>${argScores[4]}</span></div>
                                        <div><p>ë…ì°½ì„± : </p><span>${argScores[5]}</span></div>
                                    </div>
                                `);
                                $moodsBox.find('#headline').after($infoBox);
                            } else {
                                // ìˆìœ¼ë©´ ë‚´ìš© ê°±ì‹ 
                                $infoBox.html(`
                                    <div><p>ê°€ì‚¬ : </p><span>${argScores[0]}</span></div>
                                    <div><p>ì‚¬ìš´ë“œ : </p><span>${argScores[1]}</span></div>
                                    <div><p>ë©œë¡œë”” : </p><span>${argScores[2]}</span></div>
                                    <div><p>ìŠ¤í† ë¦¬í…”ë§ : </p><span>${argScores[3]}</span></div>
                                    <div><p>ìœ ê¸°ì„± : </p><span>${argScores[4]}</span></div>
                                    <div><p>ë…ì°½ì„± : </p><span>${argScores[5]}</span></div>
                                `);
                            }

                            // "ì•„ì§ ì•„ë¬´ë„ íˆ¬í‘œí•˜ì§€ ì•Šì•˜ì–´ìš”" ë¬¸êµ¬ ì œê±°
                            $moodsBox.find('p:contains("ì•„ì§ ì•„ë¬´ë„")').remove();
                            $('.chart').find('p:contains("ì•„ì§ ì•„ë¬´ë„")').remove();

                            // âœ… ì°¨íŠ¸ ì˜ì—­ ê°±ì‹ 
                            const $chartArea = $('.chart');
                            if ($chartArea.length) {
                                $chartArea.html(`<canvas id="hexRadarChart"></canvas>`);
                                renderArgChart(argLabels, argScores);
                            }
                        });

                        Swal.fire(msg, '', 'success');
                    },
                    error: function () {
                        Swal.fire('ì €ì¥ ì‹¤íŒ¨', 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                    }
                });
            });
        });

        // ì•¨ë²” ì¢‹ì•„ìš”
        $(document).on('click', '.like-album-btn', function () {
            const $btn = $(this);
            const userId = $btn.data('user-id');
            const albumId = $btn.data('album-id');

            if (!userId || userId === 0) {
                Swal.fire('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤!');
                return;
            }

            $.ajax({
                url: '/albums/toggle-like',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ userId: userId, albumId: albumId }),
                success: function (res) {
                    console.log('ì‘ë‹µ:', res, 'í˜„ì¬ ë²„íŠ¼:', $btn);
                    const liked = res.liked
                    const count = res.count;

                    // í´ë¦­í•œ ë²„íŠ¼ ë‚´ë¶€ì˜ like-textì™€ like-countë§Œ ë³€ê²½
                    $btn.find('.like-text').text(liked ? 'ì¢‹ì•„ìš”â¤ï¸' : 'ì¢‹ì•„ìš”ğŸ¤');
                    $btn.find('.like-count').text(count);
                },
                error: function () {
                    Swal.fire('ì¢‹ì•„ìš” ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            });
        });

    </script>

    <!-- ìœ¡ê° ê·¸ë˜í”„ ìŠ¤í¬ë¦½íŠ¸ -->
    <script>
        function renderArgChart(labels, values) {
            const ctx = document.getElementById('hexRadarChart').getContext('2d');

            if (window.argChartInstance) {
                window.argChartInstance.destroy();
            }

            const maxValue = Math.max(...values);
            const roundedMax = Math.ceil(maxValue / 10) * 10 || 100;

            window.argChartInstance = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'í‰ê·  ì ìˆ˜',
                        data: values,
                        backgroundColor: 'rgba(212, 185, 127, 0.2)',
                        borderColor: '#D4B97F',
                        pointBackgroundColor: '#D4B97F'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            grid: { color: '#D4B97F' },
                            angleLines: { color: '#D4B97F' },
                            pointLabels: {
                                color: '#D4B97F',
                                font: { size: 16, weight: 'bold' }
                            },
                            ticks: {
                                stepSize: 20,
                                backdropColor: 'transparent'
                            },
                            min: 0,
                            max: 100
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

    </script>



    <script th:inline="javascript">
        const argLabels = /*[[${argLabels}]]*/[];
        const argScores = /*[[${argScores}]]*/[];

        renderArgChart(argLabels, argScores);
    </script>

</body>

</html>