<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{/layouts/main_layout}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
    <title th:text="|${track.title} ë¦¬ë·°|">íŠ¸ë™ ë¦¬ë·°</title>
    <th:block th:replace="~{fragments/link::album}"></th:block>
</head>

<body layout:fragment="content">
    <div class="wrapper">
        <!-- íŠ¸ë™ ì¹´ë“œ -->
        <div class="song-card">
            <div class="song-overall">
                <div class="song-img">
                    <img th:src="@{${album.coverImage}}" alt="">
                    <span class="center-pin"></span>
                </div>
            </div>
            <div class="song-info">
                <p id="headline" th:text="${track.title}">íŠ¸ë™ëª…</p>
                <a th:href="@{artists(id=${artist.id})}">
                    <p th:text="${artist.name}">ì•„í‹°ìŠ¤íŠ¸</p>
                </a>
                <p th:text="${#dates.format(album.releaseDate, 'yyyy-MM-dd')}">ë°œë§¤ì¼</p>
                <a th:href="@{/albums(id=${album.id})}">
                    <p th:text="|${album.title}ğŸ’¿ì˜ ${track.trackNo}th track|">ì–´ë””ì•¨ë²”ì˜ ëª‡ë²ˆì§¸ê³¡</p>
                </a>
                <th:block th:if="${score == null or score.averageScore == null}">
                    <p>ì•„ì§ ë¦¬ë·°ê°€ ì—†ì–´ìš” ğŸ˜…</p>
                </th:block>
                <th:block th:if="${score != null and score.averageScore != null}">
                    <p
                        th:text="|ğŸ”® ${#numbers.formatDecimal(score.averageScore, 0, 0)}ì  (âœ…ë¦¬ë·° ${score.criticCount}ê°œ, ì¼ë°˜ë¦¬ë·° ${score.userCount}ê°œ)|">
                    </p>
                </th:block>
                <div>
                    <div class="btn btn-gold">ì¢‹ì•„ìš” â¤ï¸</div>
                    <div class="btn btn-gold">ì €ì¥ ğŸ’¾</div>
                </div>
            </div>
        </div>
        <!-- íŠ¸ë™ ì¹´ë“œ ë -->
        <!-- iframe -->
        <div class="iframe-card">
            <div class="spotify">
                <!-- ìŠ¤í¬í‹°íŒŒì´ ë¡œê·¸ì¸ ë˜ì–´ìˆì§€ì•Šì„ë•Œ 30ì´ˆ ë¯¸ë¦¬ë“£ê¸° ì˜¤ë””ì˜¤íƒœê·¸ -->
                <iframe th:src="|https://open.spotify.com/embed/track/${track.id}?utm_source=generator|" frameborder="0"
                    allowfullscreen allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
                    loading="lazy">
                </iframe>
            </div>
            <div class="youtube">
                <th:block th:if="${!#strings.isEmpty(track.mvUrl)}">
                    <iframe width="560" height="315" th:src="|https://www.youtube.com/embed/${track.mvUrl}|"
                        title="YouTube video player" frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                        referrerpolicy="strict-origin-when-cross-origin" allowfullscreen>
                    </iframe>
                </th:block>
                <!-- â‘¡ MV URLì´ ì—†ì„ ë•Œ â†’ ì¤€ë¹„ì¤‘ ì´ë¯¸ì§€ -->
                <th:block th:if="${#strings.isEmpty(track.mvUrl)}">
                    <img th:src="@{/img/wait_plz.png}" alt="ë®¤ì§ë¹„ë””ì˜¤ ì¤€ë¹„ì¤‘" width="560" height="315"
                        style="object-fit:cover;">
                </th:block>
            </div>
        </div>
        <!-- iframe ì¹´ë“œ ë -->

        <!-- í‰ì &ë¦¬ë·° -->
        <div class="review-card">
            <p id="headline">í‰ì  & ë¦¬ë·°</p>
            <div class="review-score">
                <th:block th:if="${score == null or score.averageScore == null}">
                    <h1 id="headline">ì²« ë¦¬ë·°ë¥¼ ì‘ì„±í•´ë³´ì„¸ìš” ğŸ¤©</h1>
                </th:block>
                <th:block th:if="${score != null and score.averageScore != null}">
                    <h1 id="headline" th:text="|ğŸ”® ${#numbers.formatDecimal(score.averageScore, 0, 0)}|"></h1>
                </th:block>
                <th:block th:if="${score != null and score.averageScore != null}">
                    <div class="score-bar">
                        <div class="score-fill"
                            th:style="'width:' + ${#numbers.formatDecimal(score.averageScore, 1, 1)} + '%'">
                            <span th:text="${#numbers.formatDecimal(score.averageScore, 0, 0)}"></span>
                        </div>
                    </div>
                </th:block>
            </div>
            <div class="review-container">
                <ul class="review-list">
                    <th:block th:each="rv : ${review}">
                        <li class="comment" th:id="|rv-${rv.id}|" th:data-review-id="${rv.id}"
                            th:data-track-id="${track.id}">
                            <!-- ì‘ì„±ì + í”„ë¡œÂ·ì ìˆ˜ -->
                            <div class="name-and-score">
                                <p th:text="${rv.reviewer.nickname}">ë‹‰ë„¤ì„</p>
                                <span th:if="${rv.reviewer.pro}">âœ…</span>
                                <span>ğŸ”® <span th:text="${rv.rating}">0</span></span>
                            </div>

                            <div class="review-content" th:text="${rv.content}">ë‚´ìš©</div>

                            <div class="review-util">
                                <time th:text="${#temporals.format(rv.createdAt,'yyyy.MM.dd')}">ë‚ ì§œ</time>
                                <a href="#" class="like-btn" th:data-id="${rv.id}">â¤ï¸ <span
                                        th:text="${rv.likes}">0</span></a>

                                <!-- ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼: ì‘ì„±ì or ADMIN -->
                                <span
                                    th:if="${(isAdmin != null and isAdmin) or (loginUser != null and rv != null and loginUser.id == rv.userId)}">
                                    <a href="#" class="edit-btn" th:data-id="${rv.id}">ìˆ˜ì •</a>
                                    <a href="#" class="del-btn" th:data-id="${rv.id}">ì‚­ì œ</a>
                                </span>
                            </div>
                        </li>
                    </th:block>
                    <!-- <li class="comment">
                        <div class="name-and-score">
                            <p id="subtitle">í˜í˜ì‚¬ë‘ë‹¨12</p>
                            <p> ğŸ”® 100</p>
                        </div>
                        <div class="review-content">
                            <p>ìš°ë¦¬ í˜í˜ ë§ì´ ì‚¬ë‘í•´ì£¼ì„¸ìš”222</p>
                        </div>
                        <div class="review-util">
                            <p>2025.05.21</p>
                            <a href="#">â¤ 3</a>
                            <a href="#" id="report">ì‹ ê³ </a>
                        </div>
                    </li> -->
                </ul>
            </div>
            <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
            <div th:if="${loginUser != null}" class="reply">
                <form id="reviewForm">
                    <input type="hidden" id="trackId" th:value="${track.id}">
                    <textarea id="content" placeholder="ë¦¬ë·°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”" required></textarea>
                    <div class="score-and-submit">
                        <input type="number" id="rating" min="0" max="100" placeholder="0~100ì " required>
                        <button type="submit" class="btn btn-gold">ë¦¬ë·°ì‘ì„±</button>
                    </div>
                </form>
            </div>
        </div>
        <!-- í‰ì &ë¦¬ë·° ë -->

        <!-- ë¶„ìœ„ê¸° -->
        <div class="mood-card">
            <div class="chart">
                <canvas id="hexRadarChart"></canvas>
            </div>
            <div class="mood-vote">
                <div class="vote-header">
                    <p id="headline">Mood Tag</p>
                </div>
                <div class="moods">
                    <!-- ë¶„ìœ„ê¸° ë°˜ë³µë¬¸ -->
                    <div class="btn btn-gold">ë¶„ìœ„ê¸°1</div>
                    <div class="btn btn-gold">ë¶„ìœ„ê¸°1324</div>
                    <div class="btn btn-gold">ë¶„ìœ„ê¸°133</div>
                    <div class="btn btn-gold">ë¶„ìœ„ê¸°1</div>
                    <div class="btn btn-gold">ë¶„ìœ„ê¸°144</div>
                    <div class="btn btn-gold">ë¶„ìœ„ê¸°1</div>
                </div>
                <button class="btn btn-gold">ë¶„ìœ„ê¸° íˆ¬í‘œ</button>
            </div>
        </div>
        <!-- ë¶„ìœ„ê¸° ë -->

        <!-- ì•¨ë²” íŠ¸ë™ë¦¬ìŠ¤íŠ¸ ë¶„ìœ„ê¸° ë­ë­.. -->
        <div class="info-card">
            <div class="info top5track">
                <p id="headline" th:text="|${album.title}ğŸ’¿ ğŸ”¥TOP ${#lists.size(top5List)}|"></p>
                <th:block th:each="tops, stat : ${top5List}">
                    <a th:href="@{/tracks(id=${tops.id})}">
                        <p th:text="|${stat.count}. ${tops.title}  ${tops.formattedDuration}|"></p>
                    </a>
                </th:block>
            </div>
            <div class="info album-moods">
                <p id="headline">íŠ¸ë™ì˜ ë¶„ìœ„ê¸°</p>
                <div class="mood-list">
                    <button class="btn btn-gold">ë™í•´ë¬¼ê³¼</button>
                    <button class="btn btn-gold">ë°±ë‘ì‚°ì´ ë§ˆë¥´ê³ </button>
                    <button class="btn btn-gold">ë‹³ë„ë¡ í•˜ëŠ</button>
                    <button class="btn btn-gold">ë‹³ë„ë¡ í•˜ëŠ</button>
                </div>
            </div>
            <div class="info pl-list">
                <p id="subtitle">ì´ íŠ¸ë™ì„ í¬í•¨í•œ í”Œë¦¬ğŸ¶</p>
                <p>ì˜¤ëŠ˜ í—¤ì–´ì§„ ì‚¬ëŒë“¤ì€ ìœ„í•œ í”Œë¦¬ â¤352</p>
                <p>í˜¼ììˆê³  ì‹¶ì–´ìš”,, â¤242</p>
                <p>ğŸ˜¢ğŸ˜¢ğŸ˜¢ğŸ˜¢ğŸ˜¢ğŸ˜¢ğŸ˜¢ğŸ˜¢ğŸ˜¢ â¤122</p>
                <p>í˜í˜ì‚¬ë‘ë‹¨ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ â¤64</p>
            </div>
        </div>
        <!-- ì•¨ë²” íŠ¸ë™ë¦¬ìŠ¤íŠ¸ ë¶„ìœ„ê¸° ë­ë­..ë -->

    </div>
    <script>
        const csrfToken = document.querySelector("meta[name=_csrf]").content;
        const csrfHeader = document.querySelector("meta[name=_csrf_header]").content;

        /* â”€â”€ â‘  ë“±ë¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        document.getElementById("reviewForm")?.addEventListener("submit", async e => {
            e.preventDefault();
            const trackId = document.getElementById("trackId").value;
            const rating = +document.getElementById("rating").value;
            const content = document.getElementById("content").value.trim();
            if (rating < 0 || rating > 100) { alert("0~100ì  ì…ë ¥"); return; }

            const res = await fetch(`/tracks/${trackId}/reviews`, {
                method: "POST",
                headers: { "Content-Type": "application/json", [csrfHeader]: csrfToken },
                body: JSON.stringify({ rating, content })
            });
            if (!res.ok) { alert("ë“±ë¡ ì‹¤íŒ¨"); return; }
            const rv = await res.json();
            prependReview(rv);                      // ìƒˆ ë¦¬ë·° DOM ì‚½ì… (í•¨ìˆ˜ëŠ” ë°‘ì—)
            e.target.reset();
        });

        /* â”€â”€ â‘¡ ìˆ˜ì •Â·ì‚­ì œÂ·ì¢‹ì•„ìš”: ì´ë²¤íŠ¸ ìœ„ì„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        document.querySelector(".review-list")?.addEventListener("click", async e => {
            const btn = e.target.closest(".edit-btn,.del-btn,.like-btn");
            if (!btn) return; e.preventDefault();

            const li = btn.closest("li.comment");
            const reviewId = btn.dataset.id || li.dataset.reviewId;
            const trackId = li.dataset.trackId;

            /* ì‚­ì œ */
            if (btn.matches(".del-btn")) {
                if (!confirm("ì‚­ì œí• ê¹Œìš”?")) return;
                const res = await fetch(`/tracks/${trackId}/reviews/${reviewId}`, {
                    method: "DELETE", headers: { [csrfHeader]: csrfToken }
                });
                if (res.ok) li.remove(); else alert("ì‚­ì œ ì‹¤íŒ¨");
            }

            /* ìˆ˜ì • */
            if (btn.matches(".edit-btn")) {
                const old = li.querySelector(".review-content").innerText;
                const nu = prompt("ìˆ˜ì •í•  ë‚´ìš©", old);
                if (nu == null || nu === old) return;
                const nr = prompt("ì ìˆ˜(0~100)", li.querySelector(".rating")?.innerText || "");
                if (nr == null) return;

                const res = await fetch(`/tracks/${trackId}/reviews/${reviewId}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json", [csrfHeader]: csrfToken },
                    body: JSON.stringify({ rating: +nr, content: nu })
                });
                if (!res.ok) { alert("ìˆ˜ì • ì‹¤íŒ¨"); return; }
                const rv = await res.json();
                li.querySelector(".review-content").innerText = rv.content;
                li.querySelector(".rating")?.replaceChildren(`ğŸ”® ${rv.rating}`);
            }

            /* ì¢‹ì•„ìš” */
            if (btn.matches(".like-btn")) {
                const res = await fetch(`/tracks/${trackId}/reviews/${reviewId}/like`, {
                    method: "POST", headers: { [csrfHeader]: csrfToken }
                });
                if (res.ok) { const { likes } = await res.json(); btn.querySelector("span").innerText = likes; }
            }
        });

        /* ìƒˆ ë¦¬ë·° DOM ì‚½ì… í—¬í¼ */
        function prependReview(rv) {
            const ul = document.querySelector(".review-list");
            const li = document.createElement("li");
            li.className = "comment";
            li.dataset.reviewId = rv.id; li.dataset.trackId = rv.trackId;
            li.innerHTML = `
                <div class="name-and-score">
                    <p>${rv.reviewer.nickname}</p>${rv.reviewer.pro ? 'âœ…' : ''}
                    <span class="rating">ğŸ”® ${rv.rating}</span>
                </div>
                <div class="review-content">${rv.content}</div>
                <div class="review-util">
                    <time>${rv.createdAt.slice(0, 10).replace(/-/g, '.')}</time>
                    <a href="#" class="like-btn" data-id="${rv.id}">â¤ï¸ <span>${rv.likes}</span></a>
                    <span><a href="#" class="edit-btn" data-id="${rv.id}">ìˆ˜ì •</a>
                        <a href="#" class="del-btn"  data-id="${rv.id}">ì‚­ì œ</a></span>
                </div>`;
            ul.prepend(li);
        }

    </script>
</body>

</html>