<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{/layouts/main_layout}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="|${track.title} 리뷰|">트랙 리뷰</title>
    <th:block th:replace="~{fragments/link::album}"></th:block>
</head>

<body layout:fragment="content">
    <div class="wrapper">
        <!-- 트랙 카드 -->
        <div class="song-card">
            <div class="song-overall">
                <div class="song-img">
                    <img th:src="@{${album.coverImage}}" alt="">
                    <span class="center-pin"></span>
                </div>
            </div>
            <div class="song-info">
                <p id="headline" th:text="${track.title}">트랙명</p>
                <a th:href="@{artists(id=${artist.id})}">
                    <p th:text="${artist.name}">아티스트</p>
                </a>
                <p th:text="${#dates.format(album.releaseDate, 'yyyy-MM-dd')}">발매일</p>
                <a th:href="@{/albums(id=${album.id})}">
                    <p th:text="|${album.title}💿의 ${track.trackNo}th track|">어디앨범의 몇번째곡</p>
                </a>
                <th:block th:if="${score == null or score.averageScore == null}">
                    <p>아직 리뷰가 없어요 😅</p>
                </th:block>
                <th:block th:if="${score != null and score.averageScore != null}">
                    <p
                        th:text="|🔮 ${#numbers.formatDecimal(score.averageScore, 0, 0)}점 (✅리뷰 ${score.criticCount}개, 일반리뷰 ${score.userCount}개)|">
                    </p>
                </th:block>
                <div>
                    <div class="btn btn-gold">좋아요 ❤️</div>
                    <div class="btn btn-gold">저장 💾</div>
                </div>
            </div>
        </div>
        <!-- 트랙 카드 끝 -->
        <!-- iframe -->
        <div class="iframe-card">
            <div class="spotify">
                <!-- 스포티파이 로그인 되어있지않을때 30초 미리듣기 오디오태그 -->
                <iframe th:src="|https://open.spotify.com/embed/track/${track.id}?utm_source=generator|" frameborder="0"
                    allowfullscreen allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
                    loading="lazy">
                </iframe>
            </div>
            <div class="youtube">
                <th:block th:if="${!#strings.isEmpty(track.mvUrl)}">
                    <iframe width="560" height="315" th:src="|https://www.youtube.com/embed/${track.mvUrl}|"
                        title="YouTube video player" frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                        referrerpolicy="strict-origin-when-cross-origin" allowfullscreen>
                    </iframe>
                </th:block>
                <!-- ② MV URL이 없을 때 → 준비중 이미지 -->
                <th:block th:if="${#strings.isEmpty(track.mvUrl)}">
                    <img th:src="@{/img/wait_plz.png}" alt="뮤직비디오 준비중" width="560" height="315"
                        style="object-fit:cover;">
                </th:block>
            </div>
        </div>
        <!-- iframe 카드 끝 -->

        <!-- 평점&리뷰 -->
        <div class="review-card">
            <p id="headline">평점 & 리뷰</p>
            <div th:fragment="scoreFragment">
                <div class="review-score">
                    <th:block th:if="${score == null or score.averageScore == null}">
                        <h1 id="headline">첫 리뷰를 작성해보세요 🤩</h1>
                    </th:block>
                    <th:block th:if="${score != null and score.averageScore != null}">
                        <h1 id="headline" th:text="|🔮 ${#numbers.formatDecimal(score.averageScore, 0, 0)}|"></h1>
                        <div class="score-bar">
                            <div class="score-fill"
                                th:style="'width:' + ${#numbers.formatDecimal(score.averageScore, 1, 1)} + '%'">
                                <span th:text="${#numbers.formatDecimal(score.averageScore, 0, 0)}"></span>
                            </div>
                        </div>
                    </th:block>
                </div>
            </div>
            <div class="review-container">
                <ul class="review-list">
                    <th:block th:each="rv : ${review}">
                        <li class="comment" th:id="|rv-${rv.id}|" th:data-review-id="${rv.id}"
                            th:data-track-id="${track.id}">
                            <div class="name-and-score">
                                <p th:text="${rv.reviewer.nickname}">닉네임</p>
                                <span th:if="${rv.critic == true }">✅</span>
                                <span>🔮 <span th:text="${rv.rating}">0</span></span>
                            </div>
                            <div class="review-content">
                                <p class="content-text" th:text="${rv.content}">내용</p>
                            </div>
                            <form class="edit-form" style="display: none;">
                                <div class="reply">
                                    <textarea class="edit-content" required></textarea>
                                    <div class="score-and-submit">
                                        <input type="number" class="edit-rating" min="0" max="100" required>
                                        <div class="button-box">
                                            <button type="submit" class="btn btn-gold">수정 완료</button>
                                            <button type="button" class="btn btn-danger">취소</button>
                                        </div>
                                    </div>
                                </div>
                            </form>
                            <div class="review-util">
                                <time th:text="${#temporals.format(rv.createdAt,'yyyy.MM.dd')}">날짜</time>
                                <a href="#" class="like-btn" th:data-id="${rv.id}">👍 <span
                                        th:text="${rv.likes}">0</span></a>
                                <!-- 수정/삭제 버튼: 작성자 or ADMIN -->
                                <span
                                    th:if="${(isAdmin != null and isAdmin) or (loginUser != null and rv != null and loginUser.id == rv.userId)}">
                                    <a href="#" class="edit-btn" th:data-id="${rv.id}">수정</a>
                                    <a href="#" class="del-btn" th:data-id="${rv.id}">삭제</a>
                                </span>
                                <a href="#">신고</a>
                            </div>
                        </li>
                    </th:block>
                    <!-- <li class="comment">
                        <div class="name-and-score">
                            <p id="subtitle">페페사랑단12</p>
                            <p> 🔮 100</p>
                        </div>
                        <div class="review-content">
                            <p>우리 페페 많이 사랑해주세요222</p>
                        </div>
                        <div class="review-util">
                            <p>2025.05.21</p>
                            <a href="#">❤ 3</a>
                            <a href="#" id="report">신고</a>
                        </div>
                    </li> -->
                </ul>
            </div>
            <!-- 페이지네이션 -->
            <div th:if="${loginUser != null}" class="reply">
                <form id="reviewForm">
                    <input type="hidden" id="trackId" th:value="${track.id}">
                    <textarea id="content" placeholder="리뷰를 입력해주세요" required></textarea>
                    <div class="score-and-submit">
                        <input type="number" id="rating" min="0" max="100" placeholder="0~100점" required>
                        <button type="submit" class="btn btn-gold">리뷰작성</button>
                    </div>
                </form>
            </div>
        </div>
        <!-- 평점&리뷰 끝 -->

        <!-- 분위기 -->
        <div class="mood-card">
            <div class="chart">
                <canvas id="hexRadarChart"></canvas>
            </div>
            <div class="mood-vote">
                <div class="vote-header">
                    <p id="headline">Mood Tag</p>
                </div>
                <div class="moods">
                    <!-- 분위기 반복문 -->
                    <div class="btn btn-gold">분위기1</div>
                    <div class="btn btn-gold">분위기1324</div>
                    <div class="btn btn-gold">분위기133</div>
                    <div class="btn btn-gold">분위기1</div>
                    <div class="btn btn-gold">분위기144</div>
                    <div class="btn btn-gold">분위기1</div>
                </div>
                <button class="btn btn-gold">분위기 투표</button>
            </div>
        </div>
        <!-- 분위기 끝 -->

        <!-- 앨범 트랙리스트 분위기 뭐뭐.. -->
        <div class="info-card">
            <div class="info top5track">
                <p id="headline" th:text="|${album.title}💿 🔥TOP ${#lists.size(top5List)}|"></p>
                <th:block th:each="tops, stat : ${top5List}">
                    <a th:href="@{/tracks(id=${tops.id})}">
                        <p th:text="|${stat.count}. ${tops.title}  ${tops.formattedDuration}|"></p>
                    </a>
                </th:block>
            </div>
            <div class="info album-moods">
                <p id="headline">트랙의 분위기</p>
                <div class="mood-list">
                    <button class="btn btn-gold">동해물과</button>
                    <button class="btn btn-gold">백두산이 마르고</button>
                    <button class="btn btn-gold">닳도록 하느</button>
                    <button class="btn btn-gold">닳도록 하느</button>
                </div>
            </div>
            <div class="info pl-list">
                <p id="subtitle">이 트랙을 포함한 플리🎶</p>
                <p>오늘 헤어진 사람들은 위한 플리 ❤352</p>
                <p>혼자있고 싶어요,, ❤242</p>
                <p>😢😢😢😢😢😢😢😢😢 ❤122</p>
                <p>페페사랑단 플레이리스트 ❤64</p>
            </div>
        </div>
        <!-- 앨범 트랙리스트 분위기 뭐뭐..끝 -->

    </div>
    <th:block th:replace="~{fragments/script::album}"></th:block>
    <script>
        $(document).ready(function () {
            const csrfHeader = $('meta[name="_csrf_header"]').attr('content');
            const csrfToken = $('meta[name="_csrf"]').attr('content');

            // CSRF 설정
            $.ajaxSetup({
                beforeSend: function (xhr) {
                    xhr.setRequestHeader(csrfHeader, csrfToken);
                }
            });
            // 점수 부분만 새로고침
            function reloadScoreBox(trackId) {
                $.ajax({
                    url: `/tracks/${trackId}/score-fragment`,
                    type: 'GET',
                    success: function (html) {
                        $('.review-score').html(html);
                        
                    },
                    error: function () {
                        console.error("점수 갱신 실패");
                    }
                });
            }
            /** ① 등록 */
            $('#reviewForm').on('submit', function (e) {
                e.preventDefault();

                const trackId = $('#trackId').val();
                const content = $('#content').val().trim();
                const rating = $('#rating').val();

                if (content === '' || rating === '') {
                    alert("내용과 점수를 모두 입력해주세요.");
                    return;
                }

                $.ajax({
                    url: `/tracks?id=${trackId}`,
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ content, rating }),
                    success: function () {
                        alert('리뷰 등록 완료!');
                        reloadScoreBox(trackId);
                        location.reload(); // 또는 동적으로 append 가능
                    },
                    error: function (xhr) {
                        console.error(xhr.responseText);
                        alert('등록 실패: ' + xhr.responseText);
                    }
                });
            });

            /** ② 수정 버튼 클릭 → 폼 열기 + 기존 내용 채우기 */
            $(document).on('click', '.edit-btn', function (e) {
                e.preventDefault();

                const li = $(this).closest('li');
                const reviewId = li.attr('data-review-id');
                const trackId = li.attr('data-track-id');
                const contentText = li.find('.content-text');
                const content = contentText.text().trim();
                const rating = li.find('.name-and-score span span').text().trim();
                // 텍스트 숨기고 폼 보여줌
                contentText.slideUp(200);
                li.find('.edit-content').val(content);
                li.find('.edit-rating').val(rating);
                li.find('.edit-form').slideDown();
            });

            /** ③ 수정 완료 → 서버 PUT 요청 */
            $(document).on('submit', '.edit-form', function (e) {
                e.preventDefault();

                const form = $(this);
                const li = form.closest('li');
                const reviewId = li.attr('data-review-id');
                const trackId = li.attr('data-track-id');
                const content = form.find('.edit-content').val().trim();
                const rating = form.find('.edit-rating').val();

                if (content === '' || rating === '') {
                    alert("내용과 점수를 모두 입력해주세요.");
                    return;
                }
                $.ajax({
                    url: `/tracks/${trackId}/review/${reviewId}`,
                    method: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify({ content, rating }),
                    success: function (updated) {
                        li.find('.content-text').text(updated.content).slideDown();
                        li.find('.name-and-score span span').text(updated.rating);
                        form.slideUp();
                        // console.log('프래그먼트 응답 확인:', html);
                        reloadScoreBox(trackId);
                    },
                    error: function (xhr) {
                        console.error(xhr.responseText);
                        alert('수정 실패: ' + xhr.responseText);
                    }
                });
            });

            /** ④ 수정 취소 */
            $(document).on('click', '.btn-danger', function () {
                $(this).closest('.edit-form').slideUp();
            });

            /** ⑤ 삭제 */
            $(document).on('click', '.del-btn', function (e) {
                e.preventDefault();

                if (!confirm('정말 삭제하시겠습니까?')) return;

                const li = $(this).closest('li');
                const reviewId = li.data('review-id');
                const trackId = li.data('track-id');

                $.ajax({
                    url: `/tracks/${trackId}/review/${reviewId}`,
                    method: 'DELETE',
                    success: function () {
                        li.slideUp(() => li.remove());
                        reloadScoreBox(trackId);
                    },
                    error: function (xhr) {
                        console.error(xhr.responseText);
                        alert('삭제 실패: ' + xhr.responseText);
                    }
                });
            });
        });
    </script>



</body>

</html>