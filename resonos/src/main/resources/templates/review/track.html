<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{/layouts/main_layout}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="|${track.title} ë¦¬ë·°|">íŠ¸ë™ ë¦¬ë·°</title>
    <th:block th:replace="~{fragments/link::album}"></th:block>
</head>

<body layout:fragment="content">
    <div class="wrapper">
        <!-- íŠ¸ë™ ì¹´ë“œ -->
        <div class="song-card">
            <div class="song-overall">
                <div class="song-img">
                    <img th:src="@{${album.coverImage}}" alt="">
                    <span class="center-pin"></span>
                </div>
            </div>
            <div class="song-info">
                <p id="headline" th:text="${track.title}">íŠ¸ë™ëª…</p>
                <a th:href="@{artists(id=${artist.id})}">
                    <p th:text="${artist.name}">ì•„í‹°ìŠ¤íŠ¸</p>
                </a>
                <p th:text="${#dates.format(album.releaseDate, 'yyyy-MM-dd')}">ë°œë§¤ì¼</p>
                <a th:href="@{/albums(id=${album.id})}">
                    <p th:text="|${album.title}ğŸ’¿ì˜ ${track.trackNo}th track|">ì–´ë””ì•¨ë²”ì˜ ëª‡ë²ˆì§¸ê³¡</p>
                </a>
                <th:block th:if="${score == null or score.averageScore == null}">
                    <p>ì•„ì§ ë¦¬ë·°ê°€ ì—†ì–´ìš” ğŸ˜…</p>
                </th:block>
                <th:block th:if="${score != null and score.averageScore != null}">
                    <p
                        th:text="|ğŸ”® ${#numbers.formatDecimal(score.averageScore, 0, 0)}ì  (âœ…ë¦¬ë·° ${score.criticCount}ê°œ, ì¼ë°˜ë¦¬ë·° ${score.userCount}ê°œ)|">
                    </p>
                </th:block>
                <div>
                    <div class="btn btn-gold">ì¢‹ì•„ìš” â¤ï¸</div>
                    <div class="btn btn-gold">ì €ì¥ ğŸ’¾</div>
                </div>
            </div>
        </div>
        <!-- íŠ¸ë™ ì¹´ë“œ ë -->
        <!-- iframe -->
        <div class="iframe-card">
            <div class="spotify">
                <!-- ìŠ¤í¬í‹°íŒŒì´ ë¡œê·¸ì¸ ë˜ì–´ìˆì§€ì•Šì„ë•Œ 30ì´ˆ ë¯¸ë¦¬ë“£ê¸° ì˜¤ë””ì˜¤íƒœê·¸ -->
                <iframe th:src="|https://open.spotify.com/embed/track/${track.id}?utm_source=generator|" frameborder="0"
                    allowfullscreen allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
                    loading="lazy">
                </iframe>
            </div>
            <div class="youtube">
                <th:block th:if="${!#strings.isEmpty(track.mvUrl)}">
                    <iframe width="560" height="315" th:src="|https://www.youtube.com/embed/${track.mvUrl}|"
                        title="YouTube video player" frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                        referrerpolicy="strict-origin-when-cross-origin" allowfullscreen>
                    </iframe>
                </th:block>
                <!-- â‘¡ MV URLì´ ì—†ì„ ë•Œ â†’ ì¤€ë¹„ì¤‘ ì´ë¯¸ì§€ -->
                <th:block th:if="${#strings.isEmpty(track.mvUrl)}">
                    <img th:src="@{/img/wait_plz.png}" alt="ë®¤ì§ë¹„ë””ì˜¤ ì¤€ë¹„ì¤‘" width="560" height="315"
                        style="object-fit:cover;">
                </th:block>
            </div>
        </div>
        <!-- iframe ì¹´ë“œ ë -->

        <!-- í‰ì &ë¦¬ë·° -->
        <div class="review-card">
            <p id="headline">í‰ì  & ë¦¬ë·°</p>
            <div th:fragment="scoreFragment">
                <div class="review-score">
                    <th:block th:if="${score == null or score.averageScore == null}">
                        <h1 id="headline">ì²« ë¦¬ë·°ë¥¼ ì‘ì„±í•´ë³´ì„¸ìš” ğŸ¤©</h1>
                    </th:block>
                    <th:block th:if="${score != null and score.averageScore != null}">
                        <h1 id="headline" th:text="|ğŸ”® ${#numbers.formatDecimal(score.averageScore, 0, 0)}|"></h1>
                        <div class="score-bar">
                            <div class="score-fill"
                                th:style="'width:' + ${#numbers.formatDecimal(score.averageScore, 1, 1)} + '%'">
                                <span th:text="${#numbers.formatDecimal(score.averageScore, 0, 0)}"></span>
                            </div>
                        </div>
                    </th:block>
                </div>
            </div>
            <div class="review-container">
                <!-- <ul class="review-list">
                    <th:block th:each="rv : ${review}">
                        <li class="comment" th:id="|rv-${rv.id}|" th:data-review-id="${rv.id}"
                            th:data-track-id="${track.id}">
                            <div class="name-and-score">
                                <p th:text="${rv.reviewer.nickname}">ë‹‰ë„¤ì„</p>
                                <span th:if="${rv.critic == true }">âœ…</span>
                                <span> ğŸ”®<span th:text="${rv.rating}">0</span></span>
                            </div>
                            <div class="review-content">
                                <p class="content-text" th:text="${rv.content}">ë‚´ìš©</p>
                            </div>
                            <form class="edit-form" style="display: none;">
                                <div class="reply">
                                    <textarea class="edit-content" required></textarea>
                                    <div class="score-and-submit">
                                        <input type="number" class="edit-rating" min="0" max="100" required>
                                        <div class="button-box">
                                            <button type="submit" class="btn btn-gold">ìˆ˜ì • ì™„ë£Œ</button>
                                            <button type="button" class="btn btn-danger">ì·¨ì†Œ</button>
                                        </div>
                                    </div>
                                </div>
                            </form>
                            <div class="review-util">
                                <time th:text="${#temporals.format(rv.createdAt,'yyyy.MM.dd')}">ë‚ ì§œ</time>
                                <button class="like-btn" th:data-review-id="${rv.id}"
                                    th:data-review-type="${reviewType}" th:data-liked="${rv.isLikedByCurrentUser}"
                                    th:text="${rv.isLikedByCurrentUser} ? 'â¤ï¸' : 'ğŸ¤'">â¤ï¸</button>

                                <span th:id="'like-count-' + ${rv.id}" th:text="${rv.likes}">0</span>

                                <button class="report-btn" th:data-review-id="${rv.id}"
                                    th:data-review-type="${reviewType}">ğŸš¨</button>
                                <span
                                    th:if="${(isAdmin != null and isAdmin) or (loginUser != null and rv != null and loginUser.id == rv.userId)}">
                                    <a href="#" class="edit-btn" th:data-id="${rv.id}">ìˆ˜ì •</a>
                                    <a href="#" class="del-btn" th:data-id="${rv.id}">ì‚­ì œ</a>
                                </span>
                            </div>
                        </li>
                    </th:block>
                </ul> -->
                <ul class="review-list" th:insert="~{review/trackFrag :: reviewItems(review=${review})}"></ul>
                <!-- ë”ë³´ê¸° ë²„íŠ¼ -->
                <div class="more-box" th:if="${hasNext}">
                    <button id="load-more-btn" data-page="1" th:data-track-id="${track.id}" class="btn btn-gold">ë¦¬ë·°
                        ë”ë³´ê¸°</button>
                </div>
                <form class="edit-form" style="display: none;">
                    <div class="reply">
                        <textarea class="edit-content" required></textarea>
                        <div class="score-and-submit">
                            <input type="number" class="edit-rating" min="0" max="100" required />
                            <div class="button-box">
                                <button type="submit" class="btn btn-gold">ìˆ˜ì • ì™„ë£Œ</button>
                                <button type="button" class="btn btn-danger">ì·¨ì†Œ</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
            <div th:if="${loginUser != null}" class="reply">
                <form id="reviewForm">
                    <input type="hidden" id="trackId" th:value="${track.id}">
                    <textarea id="content" placeholder="ë¦¬ë·°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”" required></textarea>
                    <div class="score-and-submit">
                        <input type="number" id="rating" min="0" max="100" placeholder="0~100ì " required>
                        <button type="submit" class="btn btn-gold">ë¦¬ë·°ì‘ì„±</button>
                    </div>
                </form>
            </div>
        </div>
        <!-- í‰ì &ë¦¬ë·° ë -->

        <!-- ë¶„ìœ„ê¸° -->
        <div class="mood-card">
            <div class="chart">
                <canvas id="hexRadarChart"></canvas>
            </div>
            <div class="mood-vote">
                <div class="vote-header">
                    <p id="headline">Mood Tag</p>
                </div>
                <div class="moods">
                    <!-- ë¶„ìœ„ê¸° ë°˜ë³µë¬¸ -->
                    <div class="btn btn-gold">ë¶„ìœ„ê¸°1</div>
                    <div class="btn btn-gold">ë¶„ìœ„ê¸°1324</div>
                    <div class="btn btn-gold">ë¶„ìœ„ê¸°133</div>
                    <div class="btn btn-gold">ë¶„ìœ„ê¸°1</div>
                    <div class="btn btn-gold">ë¶„ìœ„ê¸°144</div>
                    <div class="btn btn-gold">ë¶„ìœ„ê¸°1</div>
                </div>
                <button class="btn btn-gold">ë¶„ìœ„ê¸° íˆ¬í‘œ</button>
            </div>
        </div>
        <!-- ë¶„ìœ„ê¸° ë -->

        <!-- ì•¨ë²” íŠ¸ë™ë¦¬ìŠ¤íŠ¸ ë¶„ìœ„ê¸° ë­ë­.. -->
        <div class="info-card">
            <div class="info top5track">
                <p id="headline" th:text="|${album.title}ğŸ’¿ ğŸ”¥TOP ${#lists.size(top5List)}|"></p>
                <th:block th:each="tops, stat : ${top5List}">
                    <a th:href="@{/tracks(id=${tops.id})}">
                        <p th:text="|${stat.count}. ${tops.title}  ${tops.formattedDuration}|"></p>
                    </a>
                </th:block>
            </div>
            <div class="info album-moods">
                <p id="headline">íŠ¸ë™ì˜ ë¶„ìœ„ê¸°</p>
                <div class="mood-list">
                    <button class="btn btn-gold">ë™í•´ë¬¼ê³¼23</button>
                    <button class="btn btn-gold">ë°±ë‘ì‚°ì´ ë§ˆë¥´ê³ </button>
                    <button class="btn btn-gold">ë‹³ë„ë¡ í•˜ëŠ</button>
                    <button class="btn btn-gold">ë‹³ë„ë¡ í•˜ëŠ</button>
                </div>
            </div>
            <div class="info pl-list">
                <p id="subtitle">ì´ íŠ¸ë™ì„ í¬í•¨í•œ í”Œë¦¬ğŸ¶</p>
                <p>ì˜¤ëŠ˜ í—¤ì–´ì§„ ì‚¬ëŒë“¤ì€ ìœ„í•œ í”Œë¦¬ â¤352</p>
                <p>í˜¼ììˆê³  ì‹¶ì–´ìš”,, â¤242</p>
                <p>ğŸ˜¢ğŸ˜¢ğŸ˜¢ğŸ˜¢ğŸ˜¢ğŸ˜¢ğŸ˜¢ğŸ˜¢ğŸ˜¢ â¤122</p>
                <p>í˜í˜ì‚¬ë‘ë‹¨ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ â¤64</p>
            </div>
        </div>
        <!-- ì•¨ë²” íŠ¸ë™ë¦¬ìŠ¤íŠ¸ ë¶„ìœ„ê¸° ë­ë­..ë -->

    </div>
    <th:block th:replace="~{fragments/script::album}"></th:block>
    <script th:inline="javascript">
        const isLogin = [[${ loginUser != null ? 'true' : 'false'}]];
    </script>
    <script>
        $(document).ready(function () {
            const csrfHeader = $('meta[name="_csrf_header"]').attr('content');
            const csrfToken = $('meta[name="_csrf"]').attr('content');

            // CSRF ì„¤ì •
            $.ajaxSetup({
                beforeSend: function (xhr) {
                    xhr.setRequestHeader(csrfHeader, csrfToken);
                }
            });
            // ì ìˆ˜ ë¶€ë¶„ë§Œ ìƒˆë¡œê³ ì¹¨
            function reloadScoreBox(trackId) {
                $.ajax({
                    url: `/tracks/${trackId}/score-fragment`,
                    type: 'GET',
                    success: function (html) {
                        $('.review-score').html(html);

                    },
                    error: function () {
                        console.error("ì ìˆ˜ ê°±ì‹  ì‹¤íŒ¨");
                    }
                });
            }
            /** â‘  ë“±ë¡ */
            $('#reviewForm').on('submit', function (e) {
                e.preventDefault();

                const trackId = $('#trackId').val();
                const content = $('#content').val().trim();
                const rating = $('#rating').val();

                if (content === '' || rating === '') {
                    Swal.fire({
                        title: 'ë¦¬ë·°ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”',
                        text: 'ë¦¬ë·°ë¥¼ ì…ë ¥í•˜ì§€ ì•Šìœ¼ì…¨ìŠµë‹ˆë‹¤.',
                        icon: 'error',
                        confirmButtonText: 'í™•ì¸'
                    });
                    return;
                }

                $.ajax({
                    url: `/tracks?id=${trackId}`,
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ content, rating }),
                    success: function () {
                        Swal.fire({
                            title: 'ì„±ê³µ',
                            text: 'ë¦¬ë·°ë¥¼ ë“±ë¡ í•˜ì˜€ìŠµë‹ˆë‹¤.',
                            icon: 'success',
                            confirmButtonText: 'í™•ì¸'
                        }).then(() => {
                            reloadScoreBox(trackId);  // ì ìˆ˜ ë°•ìŠ¤ ë¨¼ì € ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê³ 
                            location.reload();        // ìƒˆë¡œê³ ì¹¨
                        });
                    },
                    error: function (xhr) {
                        if (xhr.status === 409) {
                            Swal.fire({
                                title: 'ì¤‘ë³µ',
                                text: 'ì´ë¯¸ ë¦¬ë·°ë¥¼ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.',
                                icon: 'warning',
                                confirmButtonText: 'í™•ì¸'
                            });
                        } else {
                            Swal.fire({
                                title: 'ì˜¤ë¥˜',
                                text: 'ë¦¬ë·° ë“±ë¡ ì¤‘ ì˜¤ë¥˜ ë°œìƒ.',
                                icon: 'error',
                                confirmButtonText: 'í™•ì¸'
                            });
                        }
                    }
                });
            });

            /** â‘¡ ìˆ˜ì • ë²„íŠ¼ í´ë¦­ â†’ í¼ ì—´ê¸° + ê¸°ì¡´ ë‚´ìš© ì±„ìš°ê¸° */
            $(document).on('click', '.edit-btn', function (e) {
                e.preventDefault();

                const li = $(this).closest('li');
                const reviewId = li.attr('data-review-id');
                const trackId = li.attr('data-track-id');
                const contentText = li.find('.content-text');
                const content = contentText.text().trim();
                const rating = li.find('.name-and-score span span').text().trim();
                // í…ìŠ¤íŠ¸ ìˆ¨ê¸°ê³  í¼ ë³´ì—¬ì¤Œ
                contentText.slideUp(200);
                li.find('.edit-content').val(content);
                li.find('.edit-rating').val(rating);
                li.find('.edit-form').slideDown();
            });

            /** â‘¢ ìˆ˜ì • ì™„ë£Œ â†’ ì„œë²„ PUT ìš”ì²­ */
            $(document).on('submit', '.edit-form', function (e) {
                e.preventDefault();

                const form = $(this);
                const li = form.closest('li');
                const reviewId = li.attr('data-review-id');
                const trackId = li.attr('data-track-id');
                const content = form.find('.edit-content').val().trim();
                const rating = form.find('.edit-rating').val();

                if (content === '' || rating === '') {
                    Swal.fire({
                        title: 'ë¦¬ë·°ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”',
                        text: 'ë¦¬ë·°ë¥¼ ì…ë ¥í•˜ì§€ ì•Šìœ¼ì…¨ìŠµë‹ˆë‹¤.',
                        icon: 'error',
                        confirmButtonText: 'í™•ì¸'
                    });
                    return;
                }
                $.ajax({
                    url: `/tracks/${trackId}/review/${reviewId}`,
                    method: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify({ content, rating }),
                    success: function (updated) {
                        li.find('.content-text').text(updated.content).slideDown();
                        li.find('.name-and-score span span').text(updated.rating);
                        form.slideUp();
                        // console.log('í”„ë˜ê·¸ë¨¼íŠ¸ ì‘ë‹µ í™•ì¸:', html);
                        reloadScoreBox(trackId);
                    },
                    error: function (xhr) {
                        console.error(xhr.responseText);
                        Swal.fire({
                            title: 'ì˜¤ë¥˜',
                            text: 'ë¦¬ë·° ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ ë°œìƒ.',
                            icon: 'error',
                            confirmButtonText: 'í™•ì¸'
                        });
                    }
                });
            });

            /** â‘£ ìˆ˜ì • ì·¨ì†Œ */
            $(document).on('click', '.btn-danger', function () {
                const form = $(this).closest('.edit-form');
                const li = form.closest('li');

                // ìˆ˜ì • í¼ ìˆ¨ê¹€
                form.slideUp();

                // ì›ë˜ ë¦¬ë·° ë‚´ìš© ë‹¤ì‹œ í‘œì‹œ
                li.find('.content-text').slideDown();
            });

            /** â‘¤ ì‚­ì œ */
            $(document).on('click', '.del-btn', function (e) {
                e.preventDefault();

                const li = $(this).closest('li');
                const reviewId = li.data('review-id');
                const trackId = li.data('track-id');

                Swal.fire({
                    title: 'ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
                    text: 'ì‚­ì œëœ ë¦¬ë·°ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'ì‚­ì œ',
                    cancelButtonText: 'ì·¨ì†Œ'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            url: `/tracks/${trackId}/review/${reviewId}`,
                            method: 'DELETE',
                            success: function () {
                                li.slideUp(() => li.remove());
                                reloadScoreBox(trackId);

                                Swal.fire({
                                    title: 'ì‚­ì œ ì™„ë£Œ',
                                    text: 'ë¦¬ë·°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.',
                                    icon: 'success',
                                    confirmButtonText: 'í™•ì¸'
                                });
                            },
                            error: function (xhr) {
                                console.error(xhr.responseText);
                                Swal.fire({
                                    title: 'ì˜¤ë¥˜',
                                    text: 'ë¦¬ë·° ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ.',
                                    icon: 'error',
                                    confirmButtonText: 'í™•ì¸'
                                });
                            }
                        });
                    }
                });
            });
        });

        $(document).on("click", ".like-btn", function () {
            if (!isLogin) {
                Swal.fire({
                    title: 'ë¡œê·¸ì¸ì„ í•´ì£¼ì„¸ìš”',
                    text: 'ë¡œê·¸ì¸ì‹œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.',
                    icon: 'error',
                    confirmButtonText: 'í™•ì¸'
                });
                return;
            }

            const btn = $(this);
            const reviewId = btn.data("review-id");
            const reviewType = btn.data("review-type");

            $.post(`/tracks/${reviewType.toLowerCase()}-reviews/${reviewId}/like`, {}, function (data) {
                btn.data("liked", data.liked);
                btn.text(data.liked ? 'â¤ï¸' : 'ğŸ¤');

                // í•˜íŠ¸ ì»¤ì¡Œë‹¤ ì‘ì•„ì§€ëŠ” ì• ë‹ˆë©”ì´ì…˜
                btn.addClass("pop-heart");
                setTimeout(() => btn.removeClass("pop-heart"), 300);

                // ì¢‹ì•„ìš” ìˆ˜ ìŠ¬ë¼ì´ë“œ ì• ë‹ˆë©”ì´ì…˜
                const countEl = $("#like-count-" + reviewId);
                const currentCount = parseInt(countEl.text(), 10);

                if (currentCount !== data.likeCount) {
                    countEl.slideUp(150, function () {
                        countEl.text(data.likeCount).slideDown(150);
                    });
                }
            }).fail(function (xhr) {
                Swal.fire({
                    title: 'ë¡œê·¸ì¸ì„ í•´ì£¼ì„¸ìš”',
                    text: 'ë¡œê·¸ì¸ì‹œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.',
                    icon: 'error',
                    confirmButtonText: 'í™•ì¸'
                });
            });
        });

        $(document).on("click", ".report-btn", function () {
            if (!isLogin) {
                Swal.fire({
                    title: "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤",
                    text: "ì‹ ê³ í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.",
                    icon: "warning",
                    confirmButtonText: "í™•ì¸"
                });
                return;
            }

            const reviewId = $(this).data("review-id");
            const reviewType = $(this).data("review-type");

            Swal.fire({
                title: "ì‹ ê³ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?",
                text: "í•´ë‹¹ ë¦¬ë·°ë¥¼ ì‹ ê³ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?",
                icon: "question",
                showCancelButton: true,
                confirmButtonText: "ì‹ ê³ ",
                cancelButtonText: "ì·¨ì†Œ"
            }).then((result) => {
                if (result.isConfirmed) {
                    $.post(`/tracks/reviews/${reviewType}/${reviewId}/report`, {}, function (data) {
                        Swal.fire({
                            title: "ì‹ ê³  ì™„ë£Œ",
                            text: `ì´ ì‹ ê³  ìˆ˜: ${data.reportCount}`,
                            icon: "success",
                            confirmButtonText: "í™•ì¸"
                        });
                    }).fail(function (xhr) {
                        if (xhr.status === 429) {
                            Swal.fire({
                                title: "ì¤‘ë³µ ì‹ ê³ ",
                                text: "ì´ë¯¸ ì‹ ê³ í•œ ë¦¬ë·°ì…ë‹ˆë‹¤.",
                                icon: "warning",
                                confirmButtonText: "í™•ì¸"
                            });
                        } else if (xhr.status === 401) {
                            Swal.fire({
                                title: "ë¡œê·¸ì¸ í•„ìš”",
                                text: "ì‹ ê³ í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.",
                                icon: "warning",
                                confirmButtonText: "í™•ì¸"
                            });
                        } else {
                            Swal.fire({
                                title: "ì˜¤ë¥˜",
                                text: "ì‹ ê³  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.",
                                icon: "error",
                                confirmButtonText: "í™•ì¸"
                            });
                        }
                    });
                }
            });
        });
        $(document).ready(function () {
            $('#load-more-btn').on('click', function () {
                const $btn = $(this);
                let page = parseInt($btn.data('page'));
                const trackId = $btn.data('track-id');
                const size = 5;

                const nextPage = page + 1;

                $.ajax({
    url: `/tracks/${trackId}/reviews/more`,
    type: 'GET',
    data: { page: nextPage, size: size },
    success: function (fragmentHtml) {
        // ë¨¼ì € ì‘ë‹µ fragmentë¥¼ jQuery ê°ì²´ë¡œ íŒŒì‹±
        const $fragment = $(fragmentHtml);

        // í”Œë˜ê·¸ íƒœê·¸ë¥¼ fragment ë‚´ë¶€ì—ì„œ ì°¾ìŒ
        const $hasNextFlag = $fragment.filter('#has-next-flag');

        // í”Œë˜ê·¸ì—ì„œ ê°’ ì½ê¸° (boolean ë¬¸ìì—´ ëŒ€ì‘)
        const hasNextRaw = $hasNextFlag.data('has-next');
        const hasNext = (hasNextRaw === true || hasNextRaw === 'true');

        // í”Œë˜ê·¸ íƒœê·¸ëŠ” ì‹¤ì œ DOMì—ëŠ” ì¶”ê°€ ì•ˆ í•´ë„ ë˜ë¯€ë¡œ ì œê±°
        $hasNextFlag.remove();

        // ë¦¬ë·° ë¦¬ìŠ¤íŠ¸ì— ë‚˜ë¨¸ì§€ ë¦¬ë·° lië“¤ë§Œ ì¶”ê°€
        $('.review-list').append($fragment);

        if (hasNext) {
            $btn.data('page', nextPage); // í˜ì´ì§€ ì¦ê°€
        } else {
            $btn.hide(); // ë”ë³´ê¸° ë²„íŠ¼ ìˆ¨ê¹€
        }
    },
    error: function () {
        alert('ë¦¬ë·°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
});
            });
        });
    </script>



</body>

</html>