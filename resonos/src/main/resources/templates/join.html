<!DOCTYPE html>
<html
    lang="ko"
    xmlns:th="http://www.thymeleaf.org"
    xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{/layouts/main_layout}"
>
<head>
  <meta charset="UTF-8">
  <meta name="_csrf" th:content="${_csrf.token}" />
  <meta name="_csrf_header" th:content="${_csrf.headerName}" />
  <title>íšŒì›ê°€ì…</title>
  <th:block th:replace="~{fragments/link::user}"></th:block>
</head>
<body>
  <th:block layout:fragment="content">
    <div class="con con-join d-flex justify-content-center">
      <form id="form" th:action="@{/join}" method="post" class="user-form" th:object="${users}">
        <h2 class="text-light mb-4">íšŒì›ê°€ì…</h2>
        <div class="input-area">
        <!-- ì•„ì´ë”” -->
        <label for="username" class="profile-edit-label">ì•„ì´ë””</label>
        <input onchange="checkField(event, 'username')" th:field="*{username}" type="text" class="form-control mb-3" placeholder="ì˜ë¬¸, ìˆ«ì í¬í•¨ 6ê¸€ì ì´ìƒ">
        <p class="fail-vali" id="usernameError"></p>
        <p class="fail-vali th" th:errors="*{username}"></p>
        <!-- ë‹‰ë„¤ì„ -->
        <label for="nickname" class="profile-edit-label">ë‹‰ë„¤ì„</label>
        <input onchange="checkField(event, 'nickname')" th:field="*{nickname}" type="text" class="form-control mb-3" placeholder="ì˜ë¬¸ + ìˆ«ì, í•œê¸€ + ìˆ«ì, ì˜ë¬¸, ìˆ«ì ì¡°í•© 2ê¸€ì ì´ìƒ 10ê¸€ì ì´í•˜">
        <p class="fail-vali" id="nicknameError"></p>
        <p class="fail-vali th" th:errors="*{nickname}"></p>
        <!-- ì´ë©”ì¼ -->
        <label for="email" class="profile-edit-label">ì´ë©”ì¼</label>
        <input onchange="checkField(event, 'email')" th:field="*{email}" type="email" class="form-control mb-3" placeholder="ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.">
        <p class="fail-vali" id="emailError"></p>
        <p class="fail-vali th" th:errors="*{email}"></p>
        <!-- ë¹„ë°€ë²ˆí˜¸ -->
        <label for="password" class="profile-edit-label">ë¹„ë°€ë²ˆí˜¸</label>
        <input onchange="checkField(event, 'password')" th:field="*{password}" type="password" class="form-control mb-3" placeholder="ì˜ë¬¸ì, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ì ì¡°í•©ìœ¼ë¡œ 8 ~ 20 ê¸€ì ì…ë ¥í•´ì£¼ì„¸ìš”.">
        <p class="fail-vali" id="passwordError"></p>
        <p class="fail-vali th" th:errors="*{password}"></p>
        <!-- ë¹„ë²ˆí™•ì¸ -->
        <label for="password2" class="profile-edit-label">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
        <input id="password2" onchange="checkPw2()" type="password" class="form-control mb-3" placeholder="ë¹„ë°€ë²ˆí˜¸ì™€ ê°™ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.">
        <p class="fail-vali" id="passwordError2"></p>
        </div>
        <button onclick="formCheck(event)" id="join-button" class="btn btn-gold w-100 mb-2" type="submit">íšŒì›ê°€ì…</button>
      </form>
    </div>
  </th:block>
  <th:block layout:fragment="pageScript">
    <script>

      let samePw = false
      let duplId = false
      let duplNick = false

      // ë¹„ë™ê¸° ìœ íš¨ì„± ê²€ì‚¬
      async function checkField(event, field) {

        if(field === 'password') {
          checkPw2()
        }

        let url = ''

        // í•„í„°ë§
        switch (field) {
          case 'username':
            url = '/check-id'
            break;
          case 'nickname':
            url = '/check-nickname'
            break;
          case 'email':
            url = '/check-email'
            break;
          case 'password':
            url = '/check-password'
            break;
          default:
            return
            break;
        }

        const errorMessage = document.getElementById(`${field}Error`)
        errorMessage.innerText = ''

        const formError = document.querySelectorAll('.fail-vali.th')
        formError.forEach(e => {
          e.innerText = ''
        });

        const input = document.getElementById(field)
        const data = {
            [field]: input.value
        }

        try {
            /* Security ì œê³µ CSRF */
            const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
            const response = await fetch(url, {
                method: "POST",
                headers: {
                    [header] : token,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(data)
            });

            if (!response.ok) {
                const errorArray = await response.json();
                errorArray.forEach(e => {
                    let field = e.field;
                    if(e.key) field = e.key
                    let message = e.defaultMessage;
                    const errorElement = document.getElementById(`${field}Error`)
                    if (errorElement) {
                      if(e.value) message = e.value
                      errorElement.textContent = message
                      errorElement.classList.remove('success')
                    }
                    if(field == 'username') duplId = false
                    if(field == 'nickname') duplNick = false
                });
                return
            }
            if(field == 'username') duplId = true
            if(field == 'nickname') duplNick = true
            const result = await response.text();
            errorMessage.classList.add('success')
            errorMessage.innerText = result
        } catch (error) {
            console.error("ìš”ì²­ ì‹¤íŒ¨:", error);
        }
      }

      function formCheck(e) {
        e.preventDefault()
        if(samePw && duplId && duplNick) {
          alert(`${document.getElementById('nickname').value} ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤. ğŸ˜Š`)
          document.getElementById('form').submit()
        }
      }

      function checkPw2() {
        let input = document.getElementById('password2')
        let pw2 = document.getElementById('passwordError2')
        if(input.value === document.getElementById('password').value) {
          pw2.classList.add('success')
          pw2.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•©ë‹ˆë‹¤.'
          samePw = true
        } else {
          pw2.classList.remove('success')
          pw2.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'
          samePw = false
        }
      }
    </script>
  </th:block>
</body>
</html>